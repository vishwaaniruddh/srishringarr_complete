from django.shortcuts import render, render_to_response
from django.http.response import HttpResponseRedirect
from django.views.generic import TemplateView
from django.urls import reverse
from ecomauth.models import userDetails
from ecomadmin.models import Cart, Support
from ecomsite import user_cart 
from django.db.models import Q
from django.shortcuts import get_object_or_404
from ecomadmin.models import ProductsReviews, ProductsRatings, PDSettingOptions, HomeSettingOptions, Order, Cart, \
BankList, OrderItem, Products , HomeSetting, ProductListSetting, Category, StateList, ProductDetailSetting, CartPageSetting, \
 Address, CheckoutPageSetting, ThankyouPageSetting, ProductListSettingOptions, CartSettingOptions, ThankUSettingOptions, \
 CheckoutSettingOptions, AddtoWishlist, ProductNotify, Support, Rent
from ecomsite.app_setting import getUserID
from django.db import connection
from django.http.response import HttpResponseRedirect, JsonResponse
from django.contrib.auth.hashers import make_password, check_password
from django.core.paginator import Paginator, EmptyPage, PageNotAnInteger
from Ecom.settings import PAYU_INFO, RAZORPAY_INFO
import time
import datetime
from datetime import datetime, date,timedelta
# from datetime import date
import hashlib
from django.views.decorators.csrf import csrf_protect, csrf_exempt
import numpy as np

from ecomsite.models import VisitorFormDetail

import razorpay

from django.core.mail import EmailMultiAlternatives
from django.template.loader import render_to_string
from django.utils.html import strip_tags

from django.core.mail import send_mail
# from Ecom.settings import ADMIN_EMAIL
import math

STRIP_WORDS = ['a', 'an', 'and', 'by', 'for', 'from', 'in', 'no', 'not',
               'of', 'on', 'or', 'that', 'the', 'to', 'with']


def _prepare_words(q):
    words = q.split()
    for common in STRIP_WORDS:
        if common in words:
            words.remove(common)
    return words[0:5]


# Create your views here.
class Home(TemplateView):
    template_name = 'ecomsite/index.html'
    
    def post(self, request, *args, **kwargs):
        postdata = request.POST.copy()
        
        # if request.POST.get('searchbtn') == 'Search':
        #     request.session['page'] = 'home'
        #     try:
        #         strValue = postdata.get('searchtxt')
        #     except:
        #         strValue = ''
            
        #     if strValue == '':
        #         return HttpResponseRedirect(reverse('empty_search')) 
        #     else:        
        #         return HttpResponseRedirect(reverse('search', kwargs={'stxt': strValue}))
        #     print("********************")
        #     print(strValue)
            
        # responseData = super(Home, self).get(request, *args, **kwargs)
        # return responseData 

        if request.POST.get('searchbtn') == 'Search':
            request.session['page'] = 'search'
            try:
                strValue = postdata.get('searchtxt')
            except:
                strValue = ''
            urlVar = '/search?stxt='+strValue
            
            if strValue == '':
                return HttpResponseRedirect(reverse('empty_search')) 
            else:
                return HttpResponseRedirect(urlVar) 
                        
        responseData = super(SearchView, self).get(request, *args, **kwargs)
        return responseData

    
    def get_context_data(self, **kwargs):
        # cursor = connection.cursor()
        # cursor.execute(''' SELECT id as product_id,mrp FROM `products` ''')
        # productDetailObj = dictfetchall(cursor)    
        # print("7777777777777777777777777777777777777777777777777")
        # for res in productDetailObj:
        #     print("666666666666666666666666666666666666")
        #     mrp=float(res['mrp'])
        #     product_id=res['product_id']
        #     percent_amount=None
        #     if mrp <= 40000 :
        #         percent_amount = 0.22
        #     elif mrp > 40001 & mrp <= 60000 :
        #         percent_amount = 0.17
        #     elif mrp >= 60001 :
        #         percent_amount = 0.12

        #     if percent_amount :
        #         print((mrp*percent_amount))
        #         rent_amount = math.ceil((mrp*percent_amount)/100)*100

        #     print("77777777777777777777777777777777777777")
        #     print(mrp,rent_amount,product_id) 

        #     cursor.execute(''' UPDATE products
        #     SET rent_price={0}
        #     WHERE id={1} '''.format(rent_amount,product_id)) 

        bangles_product_id = 15
        bangles_product = Products.objects.filter(categories_id=bangles_product_id, is_active=1)
        print("xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx")
        for res in bangles_product:
            print(res.id)
            rplace_word = res.name.replace("Sri Shringarr Fashion ","")

            new_string =get_object_or_404(Products,id=res.id)
            new_string.name = rplace_word
            new_string.save()

        context = super(Home, self).get_context_data(**kwargs)
        if self.request.session.get('site_userId') != '0':
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
            context['cart_list'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request))
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            context['cart_list'] = Cart.objects.filter(user=self.request.session.get('site_userId'))
         
        cart_calculations = user_cart.cartCalculations(self.request)
        context['product_total'] = cart_calculations['product_total']
        
        context['product_count'] = Products.objects.filter(is_active=True, is_delete=False, user=getUserID()).count()         
        # context['product_list'] = Products.objects.filter(is_active=True, is_delete=False, user=getUserID())[:10]
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        cat_list = Category.objects.filter(is_active=True, user=getUserID())
        context['cat_list'] = cat_list
        cat_list_p = Category.objects.filter(user=getUserID(), is_active=1, parent=None)
        context['cat_list_p'] = cat_list_p
        try:
            sellerAddress = Address.objects.filter(user=getUserID()).first() 
        except:
            sellerAddress = None
    
        context['address'] = sellerAddress
        context['pageTitle'] = "Shopping Portel"

        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
            
        return context

    
# Create your views here.
class UnderConstruction(TemplateView):
    template_name = 'ecomsite/underconstruction.html'
    
    def get_context_data(self, **kwargs):
        context = super(UnderConstruction, self).get_context_data(**kwargs)
        try:
            context['user'] = get_object_or_404(userDetails, id=getUserID())
        except:
            context['user'] = None
        context['pageTitle'] = "Shopping Portel"
        return context     

     
def dictfetchall(cursor):
    "Return all rows from a cursor as a dict"
    columns = [col[0] for col in cursor.description]
    return [
        dict(zip(columns, row))
        for row in cursor.fetchall()
    ]


class ProducListingView(TemplateView):
    template_name = 'ecomsite/productlisting.html'
    successMessage = ''
    genderFilterBy = '' 
    catFilterBy = '' 
    priceFilterBy = '' 
    discountFilterBy = ''
    colorFilterBy = ''
    brandFilterBy = ''
    sizeFilterBy = ''
    stockFilterBy = ''
    product_list = ''
    paginate_by = 20
    sortBy = '0'

    def post(self, request, *args, **kwargs):
        postdata = request.POST.copy()
        catId = postdata.get('catId')
        subcatArr = getSubCats(catId)
        self.catFilterBy = ", ".join(postdata.getlist('categoryOption'))
        self.genderFilterBy = ", ".join(postdata.getlist('genderOption'))
        self.colorFilterBy = ", ".join(postdata.getlist('colorOption'))
        self.brandFilterBy = ", ".join(postdata.getlist('brandOption'))
        self.sizeFilterBy = ", ".join(postdata.getlist('sizeOption'))
        self.priceFilterBy = ", ".join(postdata.getlist('priceOption'))
        self.discountFilterBy = ", ".join(postdata.getlist('discountOption'))
        self.stockFilterBy = ", ".join(postdata.getlist('stockOption'))
        self.sortBy = postdata.get('sorting')
        if self.catFilterBy:
            categoryData = "`categories_id` IN (" + ', '.join(repr(e) for e in postdata.getlist('categoryOption')) + ")"
        else:
            categoryData = "`categories_id` IN (" + ', '.join(repr(e.id) for e in subcatArr) + ")"       
        if self.genderFilterBy:
            genderData = "`specific_for` IN (" + ', '.join(repr(e) for e in postdata.getlist('genderOption')) + ")"
        else:
            genderData = True
        if self.colorFilterBy:
            if '0' in postdata.getlist('colorOption'):
                colorData = True
            else:
                colorData = "`color` IN (" + ', '.join(repr(e) for e in postdata.getlist('colorOption')) + ")"
        else:
            colorData = True
        if self.brandFilterBy:
            if '0' in postdata.getlist('brandOption'):
                brandData = True
            else:
                brandData = "`brand` IN (" + ', '.join(repr(e) for e in postdata.getlist('brandOption')) + ")"
        else:
            brandData = True
        sizeDataArr = []
        if self.sizeFilterBy:
            if '0' in postdata.getlist('sizeOption'):
                sizeData = True
            else:
                for sizeResult in postdata.getlist('sizeOption'):
                    sizeQuery = "FIND_IN_SET(" + sizeResult + ",`size`)"
                    sizeDataArr.append(sizeQuery)
            sizeData = ' OR '.join(sizeDataArr)
        else:
            sizeData = True
        if self.priceFilterBy:
            priceQuery = ""
            for plist in postdata.getlist('priceOption'):
                if priceQuery == '':
                    if '0-0' in plist:
                        priceQuery = True
                    else:
                        priceQuery = priceQuery + str("`mrp` BETWEEN " + plist.split("-")[0] + " AND " + plist.split("-")[1])
                elif priceQuery != '': 
                    if '0-0' in plist:
                        priceQuery = True
                    else:
                        priceQuery = priceQuery + str(" OR `mrp` BETWEEN " + plist.split("-")[0] + " AND " + plist.split("-")[1])
            priceData = priceQuery
        else:
            priceData = True
        if self.discountFilterBy:
            discountQuery = ""
            for dlist in postdata.getlist('discountOption'):
                if discountQuery == '':
                    if '0' in dlist:
                        discountQuery = True
                    else:
                        if '9' in dlist:
                            discountQuery = discountQuery + str("(`discount`/`mrp`)*100 <= 10")
                        else:
                            discountQuery = discountQuery + str("(`discount`/`mrp`)*100 >= " + dlist)
                elif discountQuery != '':
                    if '0' in dlist:
                        discountQuery = True
                    else:
                        if '9' in dlist:
                            discountQuery = discountQuery + str(" OR (`discount`/`mrp`)*100 <= 10")
                        else:
                            discountQuery = discountQuery + str(" OR (`discount`/`mrp`)*100 >= " + dlist)
            discountData = discountQuery
        else:
            discountData = True
        if self.stockFilterBy:
            stockQuery = ""
            if stockQuery == '':
                if '0' in postdata.getlist('stockOption'):
                    stockQuery = True
                else:
                    if '1' in postdata.getlist('stockOption'):
                        stockQuery = stockQuery + str("quantity != 0")
                    elif '2' in postdata.getlist('stockOption'):
                        stockQuery = stockQuery + str("quantity = 0")
            elif stockQuery != '':
                if '0' in postdata.getlist('stockOption'):
                    stockQuery = True
                else:
                    if '1' in postdata.getlist('stockOption'):
                        stockQuery = stockQuery + str(" OR quantity != 0")
                    elif '2' in postdata.getlist('stockOption'):
                        stockQuery = stockQuery + str(" OR quantity = 0")
            stockData = stockQuery
        else:
            stockData = True
        
        if postdata.get('sorting') != '0':
            if postdata.get('sorting') == '1':
                sortData = "ORDER BY `mrp` ASC"
            elif postdata.get('sorting') == '2':
                sortData = "ORDER BY `mrp` DESC"
            else:
                sortData = "AND True" 
        else:
            sortData = "AND True"
                    
        if request.POST.get('searchbtn') == 'Search':
            request.session['page'] = 'home'
            try:
                strValue = postdata.get('searchtxt')
            except:
                strValue = ''
            urlVar = '/search?stxt='+strValue
            
            if strValue == '':
                return HttpResponseRedirect(reverse('empty_search')) 
            else:
                return HttpResponseRedirect(urlVar) 

        if request.POST.get('add_to_cart') == 'Add To Cart':
            self.successMessage = "Product has been added successfully!"
        
        cursor = connection.cursor()
        print('++++++++++++++++++++++++++++++')
#         print(genderData)
        print(''' SELECT *,(`discount`/`mrp`)*100 AS percent FROM `products` WHERE {0} AND is_active=True AND is_delete=False AND user_id={1} AND {2} AND {3} AND {4} AND ({5}) AND ({6}) AND ({7}) AND ({8}) {9} '''.format(categoryData, getUserID(), genderData, colorData, brandData, sizeData, priceData, discountData, stockData, sortData))
        print('++++++++++++++++++++++++++++++')
        cursor.execute(''' SELECT *,(`discount`/`mrp`)*100 AS percent FROM `products` WHERE {0} AND is_active=True AND is_delete=False AND user_id={1} AND {2} AND {3} AND {4} AND ({5}) AND ({6}) AND ({7}) AND ({8}) {9} '''.format(categoryData, getUserID(), genderData, colorData, brandData, sizeData, priceData, discountData, stockData, sortData))
        self.product_list = dictfetchall(cursor)

        

        responseData = super(ProducListingView, self).get(request, *args, **kwargs)
        return responseData 
            
    def get_context_data(self, **kwargs):
        context = super(ProducListingView, self).get_context_data(**kwargs)
        cat_id = self.kwargs['cat_id']
        # breadcrumb
        categoryDetails = Category.objects.filter(id=cat_id)
        for res in categoryDetails:
            parentCategoryDetails = Category.objects.filter(id=res.parent_id).first()
            context['parent_cats'] = parentCategoryDetails.name
            context['parent_cats_id'] = parentCategoryDetails.id
            print(parentCategoryDetails.name)
        # breadcrumb
        
        cursor = connection.cursor()
        subcatArr = getSubCats(cat_id)
        # context['sub_cats'] = subcatArr
        context['sub_cats'] = subcatArr[0].name

        try:
            catObj = Category.objects.filter(is_active=True,is_delete=False)
        except:
            catObj = None

        context['categories'] = catObj
        
        context['product_count'] = Products.objects.filter(categories_id__in=subcatArr, is_active=True, is_delete=False, user_id=getUserID()).count()
        
        if self.genderFilterBy == '' and self.catFilterBy == '' and self.priceFilterBy == '' and self.discountFilterBy == '' and self.colorFilterBy == '' and self.brandFilterBy == '' and self.sizeFilterBy == '' and self.stockFilterBy == '' and self.sortBy == "0":
            context['product_list'] = Products.objects.filter(categories_id__in=subcatArr, is_active=True, is_delete=False, user_id=getUserID()).order_by('-sku')
        else:
            context['product_list'] = self.product_list


#############Rahul###############02-08-19###############for updating the the value in product list page#########
        for val in context['product_list']:
            mrp = val.mrp
            first_base_percent = 22
            if mrp < 40000:
                amount = (mrp*(first_base_percent))/100
                
                rent_amt = math.ceil(amount/100)*100
                #print(amount)
                print(rent_amt)
                print(val.id)
                #finalData = "Rs. " + Number(rent_amt) + " For " + 3 + " days"
                #print(finalData)
                print('sssssssssssssssssssssssssssss')
                val.rent_price =  rent_amt
                print('sssssssssssssssssssssssssssssssssssssssssssssssssssssssssss')
                print(val.rent_price)
                val.save()
##########Rahul##################02-08-19###########for updating the the value in product list page###############                

        context['wishlist'] = AddtoWishlist.objects.filter(user=self.request.session.get('site_userId'))  
        paginator = Paginator(context['product_list'], self.paginate_by)
        page = self.request.GET.get('page')
        
        try:
            currentPage = paginator.page(page)
        except PageNotAnInteger:
            currentPage = paginator.page(1)
        except EmptyPage:
            currentPage = paginator.page(paginator.num_pages)
        
        if self.sortBy != "0":
            context['sort'] = self.sortBy
        
        context['current_page'] = currentPage

        context['gender_filter'] = self.genderFilterBy
        context['cat_filter'] = self.catFilterBy
        context['price_filter'] = self.priceFilterBy
        context['discount_filter'] = self.discountFilterBy
        context['color_filter'] = self.colorFilterBy
        context['brand_filter'] = self.brandFilterBy
        context['size_filter'] = self.sizeFilterBy
        context['stock_filter'] = self.stockFilterBy
        # selected filter
        list_setting = ProductListSetting.objects.filter(user_id=getUserID()).first()
        context['prolist_seting_option'] = ProductListSettingOptions.objects.filter(user_id=getUserID()).first()
        context['list_setting'] = list_setting
        context['isLogo'] = list_setting.logo
        context['isTagline'] = list_setting.headline
        context['isMenu'] = list_setting.menu
        context['isSearchBar'] = list_setting.searchbar
        context['isCart'] = list_setting.cart_symbol 
        context['isFooter'] = list_setting.footer
        context['cat_list'] = Category.objects.filter(user_id=getUserID())
        catIds = ', '.join(repr(e.id) for e in subcatArr)

        cursor.execute(''' SELECT * FROM `products` WHERE `categories_id` IN ({0}) AND is_active=True AND is_delete=False AND user_id={1} GROUP BY brand '''.format(catIds, getUserID()))
        context['brand'] = dictfetchall(cursor)

        cursor.execute(''' SELECT * FROM `products` WHERE `categories_id` IN ({0}) AND is_active=True AND is_delete=False AND user_id={1} GROUP BY color '''.format(catIds, getUserID()))
        context['color'] = dictfetchall(cursor)
        
        cursor.execute(''' SELECT size FROM `products` WHERE `categories_id` IN ({0}) AND is_active=True AND is_delete=False AND user_id={1} GROUP BY size '''.format(catIds, getUserID()))
        context['sizes'] = dictfetchall(cursor)
        
        allSize = []
        for size in context['sizes']:
            sizes = size['size'].split(',')
            for sizeResult in sizes:
                allSize.append(sizeResult)
        context['splitsizes'] = np.unique(allSize)
        
        context['pageTitle'] = "Product Listing"
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        if self.request.session.get('site_userId') != '0':
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
            context['cart_list'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request))
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            context['cart_list'] = Cart.objects.filter(user=self.request.session.get('site_userId'))
         
        cart_calculations = user_cart.cartCalculations(self.request)
        context['product_total'] = cart_calculations['product_total']
        try:
            sellerAddress = Address.objects.filter(user=getUserID()).first() 
        except:
            sellerAddress = None
    
        context['address'] = sellerAddress
        cat_list_p = Category.objects.filter(user=getUserID(), is_active=1, parent=None)
        context['cat_list_p'] = cat_list_p

        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username

        return context
    

def getSubCats(cat_id):
    if cat_id == '0':
        cat = Category.objects.filter(is_active=1, is_delete=False)
    else:
        cat = Category.objects.filter(parent_id=cat_id)
    
    if cat.count() == 0:
        subcatArr = []
        main_cat = Category.objects.filter(id=cat_id)
        subcatArr = main_cat
    
    if cat.count() > 0:
        subcatArr = ''
        for sc in cat:
            level = Category.objects.filter(parent_id=sc.id)
            if level.count() > 0:
                subcatArr = level
            else:
                subcatArr = cat
    return subcatArr

    
class ProducDetailView(TemplateView):
    template_name = 'ecomsite/productdetail.html'
    
    def post(self, request, *args, **kwargs):
        postdata = request.POST.copy()
        prod_slug = self.kwargs['product_slug']
        
        if request.POST.get('product_details') == 'Check':
            if postdata.get('pincode'):
                request.session['pincode'] = postdata.get('pincode')
        
        elif request.POST.get('product_details') == 'Notify Me':
            productDetails = get_object_or_404(Products, slug=prod_slug)
            try:
                product_notify = get_object_or_404(ProductNotify, user_id=request.session.get('site_userId'), product_id=productDetails.id)
            except:
                product_notify = None
                
            if product_notify is None:
                product_notify = ProductNotify()
            product_notify.product = get_object_or_404(Products, slug=prod_slug)
            try:
                product_notify.user = get_object_or_404(userDetails, id=request.session.get('site_userId'))
            except:
                product_notify.user = None
            product_notify.seller = get_object_or_404(userDetails, id=getUserID())
            if postdata.get('user_info'):
                product_notify.user_info = postdata.get('user_info')
            product_notify.save()
            
        # if request.POST.get('searchbtn') == 'Search':
        #     request.session['page'] = 'home'
        #     try:
        #         strValue = postdata.get('searchtxt')
        #     except:
        #         strValue = ''
            
        #     if strValue == '':
        #         return HttpResponseRedirect(reverse('empty_search')) 
        #     else:        
        #         return HttpResponseRedirect(reverse('search', kwargs={'stxt': strValue}))
                
        # responseData = super(ProducDetailView, self).get(request, *args, **kwargs)
        # return responseData

        if request.POST.get('searchbtn') == 'Search':
            request.session['page'] = 'search'
            try:
                strValue = postdata.get('searchtxt')
            except:
                strValue = ''
            urlVar = '/search?stxt='+strValue
            
            if strValue == '':
                return HttpResponseRedirect(reverse('empty_search')) 
            else:
                return HttpResponseRedirect(urlVar) 

        if request.POST.get('add_to_cart') == 'Add To Cart':
            cart_details_obj = Cart()
            cart_details_obj.quantity = True
            cart_details_obj.is_rent = True
            cart_details_obj.days_index = postdata.get('selected_days',None)
            cart_details_obj.form_date = postdata.get('from_selected_days',None)
            cart_details_obj.to_date = postdata.get('to_selected_days',None)
            # <!-- vikrant 130920 -->
            cart_details_obj.bust_size=postdata.get('bust_size',None)
            cart_details_obj.waist_size=postdata.get('waist_size',None)
            cart_details_obj.hips_size=postdata.get('hip_size',None)
            print(cart_details_obj.bust_size)
            # <!-- vikrant 130920 -->
            print("GGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGG")
            cart_details_obj.total_final_price = postdata.get('final_amount',None)
            cart_details_obj.total_final_price = postdata.get('deposite_amount',None)
            cart_details_obj.save()
            print(cart_details_obj.bust_size)
        responseData = super(SearchView, self).get(request, *args, **kwargs)
        return responseData
    
    def get_context_data(self, **kwargs):
        context = super(ProducDetailView, self).get_context_data(**kwargs)
        prod_slug = self.kwargs['product_slug']
        context['product_count'] = Products.objects.filter(is_active=True, is_delete=False, user=getUserID()).count()
        context['all_product_list'] = Products.objects.filter(is_active=True, is_delete=False, user=getUserID())
        productDetails =  Products.objects.filter(slug=prod_slug, is_active=True, is_delete=False, user=getUserID()).first()
        context['product_details'] = productDetails
        product = Products.objects.filter(slug=prod_slug, is_active=True, is_delete=False, user=getUserID()).first()
        context['product_name'] = product.name
        ####### RAHUL __19-08-19___##########
        context['bust_size'] = product.bust_size
        context['hips_size'] = product.hips_size
        context['waist_size'] = product.waist_size

        ########### vikrant 11092019 ###############
        bust_list=[]
        waist_list=[]
        hips_list=[]
        try:
            for b in range(30,int(context['bust_size']) + 1):
                bust_list.append(int(b))
            print(bust_list)
            context['busts'] = bust_list
            print(context['busts'])    
            print("BUSTTTTTTTTTTTTTTTT")

            for w in range(24,int(context['waist_size']) + 1):
                waist_list.append(int(w))
            print(waist_list)
            context['waists'] = waist_list
            print(context['waists'])    
            print("WAISTTTTTTTTTTTTTTT")

            for h in range(24,int(context['hips_size']) + 1):
                hips_list.append(int(h))
            print(hips_list)
            context['hips'] = hips_list
            print(context['hips'])    
            print("HIPSSSSSSSSSSSSSSS")
            ########### vikrant 11092019 ###############
        except:
            pass


        # context['product_details']
        # context['product_details']
        print(context['bust_size'])
        print(context['hips_size'])
        print(context['waist_size'])
        ####### RAHUL __19-08-19___##########
        context['category'] = {'categories_id':productDetails.categories_id} 
        context['category_id'] = productDetails.categories_id
        context['parent_id'] = productDetails.categories.parent_id
        categoryDetails = Category.objects.filter(id=productDetails.categories_id)
        for res in categoryDetails:
            parentCategoryDetails = Category.objects.filter(id=res.parent_id).first()
            context['parent_cats'] = parentCategoryDetails.name
            print(parentCategoryDetails.name)

        context['ratings'] = ProductsRatings.objects.filter(product=product).count()
        productRatingList = ProductsRatings.objects.filter(product=product)
        
        totalRatings = 0
        for ratings in productRatingList:
            totalRatings = totalRatings + ratings.get_int_ratings()
        context['cart_setting_option'] = CartSettingOptions.objects.filter(user=getUserID()).first()
        # if self.request.session.get('pincode') != 0:
        #     context['distance'] = user_cart.calculateDistance(self.request.session.get('pincode'))
        #     context['delivery_charge'] = user_cart.calculateDeliveryCharge(self.request.session.get('pincode'), context['cart_setting_option'])
        # else:
        #     context['delivery_charge'] = 0 
        #     context['distance'] = 0   
        context['avg_ratings'] = (totalRatings / (productRatingList.count())) if totalRatings > 0 else  0
        context['reviews'] = ProductsReviews.objects.filter(product=product).count()
        context['reviews_list'] = ProductsReviews.objects.filter(product=product)
     
        prod_detail_setting = ProductDetailSetting.objects.filter(user=getUserID()).first()
        context['product_details_options'] = PDSettingOptions.objects.filter(user=getUserID()).first()
        
        context['prod_detail_setting'] = prod_detail_setting
        context['isLogo'] = prod_detail_setting.logo
        context['isTagline'] = prod_detail_setting.headline
        context['isMenu'] = prod_detail_setting.menu
        context['isSearchBar'] = prod_detail_setting.searchbar
        context['isCart'] = prod_detail_setting.cart_symbol 
        context['isFooter'] = prod_detail_setting.footer
        context['pageTitle'] = "Shopping Portel"
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        if self.request.session.get('site_userId') != '0':
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
            context['cart_list'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request))
            context['cart_details'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request),product_id = productDetails.id).first()
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            context['cart_list'] = Cart.objects.filter(user=self.request.session.get('site_userId'))
            context['cart_details'] = Cart.objects.filter(user=self.request.session.get('site_userId'),product_id = productDetails.id).first()
         
        cart_calculations = user_cart.cartCalculations(self.request)
        context['product_total'] = cart_calculations['product_total']
         
        cat_list = Category.objects.filter(user=getUserID())
        context['cat_list'] = cat_list 
        try:
            sellerAddress = Address.objects.filter(user=getUserID()).first() 
        except:
            sellerAddress = None
    
        context['address'] = sellerAddress
        cat_list_p = Category.objects.filter(user=getUserID(), is_active=1, parent=None)
        context['cat_list_p'] = cat_list_p
        context['rent_details'] = Rent.objects.filter(user=getUserID()).first()


        categoryDetails = Category.objects.filter(id=productDetails.categories_id)
        for res in categoryDetails:
            parentCategoryDetails = Category.objects.filter(id=res.parent_id).first()
            context['parent_cats'] = parentCategoryDetails.name
            context['parent_cats_id'] = parentCategoryDetails.id
            print(parentCategoryDetails.name)

        cursor = connection.cursor()
        subcatArr = getSubCats(productDetails.categories_id)
        context['sub_cats'] = subcatArr
        context['sub_cats'] = subcatArr[0].name
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
        
        return context

    
class CartView(TemplateView):
    template_name = 'ecomsite/cart.html'
    successMessage = ''
    
    def post(self, request, *args, **kwargs):
        postdata = request.POST.copy()
        if request.POST.get('cart_form_btn') == 'REMOVE': 
            Cart.objects.filter(product_id=postdata.get('pid'), cart_id=postdata.get('cid')).delete()
            self.successMessage = "Product has been removed from Cart!"
        
        elif request.POST.get('cart_form_btn') == 'Clear Cart':
            # if request.session.get('site_userId') == '0' or request.session.get('site_userId') == None:
            Cart.objects.filter(cart_id=postdata.get('cid')).delete()
            self.successMessage = "Cart has been cleared!"
        
        elif request.POST.get('cart_form_btn') == 'Add from wishlist':
            return HttpResponseRedirect(reverse('wishlist'))  
        
        elif request.POST.get('cart_form_btn') == 'CONTINUE SHOPPING':
            return HttpResponseRedirect(reverse('index'))
        
        elif request.POST.get('cart_form_btn') == 'PROCEED TO CHECKOUT':
            return HttpResponseRedirect(reverse('checkout'))  
        
        elif request.POST.get('cart_form_btn') == 'Check':
            if postdata.get('pincode'):
                request.session['pincode'] = postdata.get('pincode')
        
        elif request.POST.get('cart_form_btn') == 'Apply Coupon':
            coupon_code = postdata.get('coupon_code')
            msg = user_cart.check_coupon_validity(request, coupon_code)
            print('+++++++++++++++++++++++++++++++++')
            print(msg)
        
        if request.POST.get('searchbtn') == 'Search':
            request.session['page'] = 'home'
            try:
                strValue = postdata.get('searchtxt')
            except:
                strValue = ''
            
            if strValue == '':
                return HttpResponseRedirect(reverse('empty_search')) 
            else:        
                return HttpResponseRedirect(reverse('search', kwargs={'stxt': strValue}))
                        
        responseData = super(CartView, self).get(request, *args, **kwargs)
        return responseData
    
    def get_context_data(self, **kwargs):
        context = super(CartView, self).get_context_data(**kwargs)
        cartCount = 0
        cartList = None

        if self.request.session.get('site_userId') == '0' or self.request.session.get('site_userId') == None:
            cartCount = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
            cartList = Cart.objects.filter(cart_id=user_cart._cart_id(self.request))
        else:
            cartCount = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            cartList = Cart.objects.filter(user=self.request.session.get('site_userId'))
        
        context['cart_count'] = cartCount
        context['cart_list'] = cartList
        cursor = connection.cursor()
        cursor.execute('''SELECT products.sku,cart_details.product_id, userdetails.id FROM `products`, `cart_details`,`userdetails` WHERE products.id = cart_details.product_id and cart_details.user_id = userdetails.id''')
        sku = dictfetchall(cursor)
        print(sku)
        context['skus'] = sku
        
        if(len(sku) == 0):
            print("YESSSSSSSSSSSSS")

        else:
            print("NOOO")
            lastsku = sku[-1]
            context['last'] = lastsku            
            print(context['last'])

        # skucount = len([skus for skus in sku])
        # print(skucount)

        # context['length'] = skucount
        ###########RAHULLLLLLLLLLLLLLLLLLLLLLL#####03-09-2019###############################
        print("YESSSSSSSSSSSSS")
        context['cart_setting_option'] = CartSettingOptions.objects.filter(user=getUserID()).first()
        cart_calculations = user_cart.cartCalculations(self.request)
        context['product_total'] = cart_calculations['product_total']
        context['cart_total'] = cart_calculations['cart_total']
         # <!--  vikrant 190920-->    
        context['cart_count'] = cart_calculations['cart_count']     
        quantity = 0
        see = 0
        for cart_data in cartList:
            
            quantity = quantity + cart_data.quantity
            categoryid = cart_data.product.categories_id
            print(categoryid)
            if categoryid == 3:
                see = see + cart_data.product.quantity
        print(see)
        print("MILA KYA")
        print(quantity) 
        if see !=0:
            SC = cart_calculations['total_shipping_charge'] * quantity
            print(SC)
            shipping_charge = SC - cart_calculations['total_shipping_charge'] * see
            print(shipping_charge)
            total_shipping_charge = (500 * see) + shipping_charge
            print(total_shipping_charge)
        
        else:
            total_shipping_charge = cart_calculations['total_shipping_charge'] 
        print(total_shipping_charge)
        print(cart_calculations['total_shipping_charge'])
        print("HOPE SO AAAYO HOOOOOO")

        context['total_shipping_charge'] = total_shipping_charge
        if context['product_total'] > 5000:
            context['amount'] = cart_calculations['product_total']

        else:
            
            context['amount'] = cart_calculations['product_total'] + total_shipping_charge

        # print(context['total_shipping_charge'])
        print("((((((((((((((((((")
        ###########RAHULLLLLLLLLLLLLLLLLLLLLLL#####03-09-2019###############################
        if cartList:
            context['coupon_code'] = cartList[0].coupon
        else:
            context['coupon_code'] = ''    
        
        # if self.request.session.get('pincode') != 0:
        #     context['distance'] = user_cart.calculateDistance(self.request.session.get('pincode'))
        #     context['delivery_charge'] = user_cart.calculateDeliveryCharge(self.request.session.get('pincode'), context['cart_setting_option'])
        cart_setting = CartPageSetting.objects.filter(user=getUserID()).first()
        context['banklist'] = BankList.objects.all()
        context['cart_setting'] = cart_setting
        context['isLogo'] = cart_setting.logo
        context['isTagline'] = cart_setting.headline
        context['isMenu'] = cart_setting.menu
        context['isFooter'] = cart_setting.footer
        context['isSearchBar'] = cart_setting.searchbar
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        cat_list = Category.objects.filter(user=getUserID())
        context['cat_list'] = cat_list
        context['pageTitle'] = "Cart"
        context['successMessage'] = self.successMessage
        try:
            sellerAddress = Address.objects.filter(user=getUserID()).first() 
        except:
            sellerAddress = None
    
        context['address'] = sellerAddress
        cat_list_p = Category.objects.filter(user=getUserID(), is_active=1, parent=None)
        context['cat_list_p'] = cat_list_p
        context['rent_details'] = Rent.objects.filter(user=getUserID()).first()
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
        return context


def logConsole(dataValue):
    print('+++++++++++++++++++++')
    print('')
    print(dataValue)
    print('')
    print('++++++++++++++++++++++++++')

class CheckoutView(TemplateView):
    template_name = 'ecomsite/checkout.html'
    allStateList = StateList.objects.all()
    successMessage = ''
    
    def post(self, request, *args, **kwargs):
        postdata = request.POST.copy()
        dCharges = 0
        if request.POST.get('checkout') == 'Submit':
            try:
                add = get_object_or_404(Address, user=request.session.get('site_userId'))
            except:
                add = None
                
            if add is None:
                add = Address()   
                self.successMessage = "Setting saved successfully"
            else:
                self.successMessage = "Setting updated successfully"         
        
            add.name = postdata['ba_full_name']
            add.address = postdata['ba_address']
            add.area = postdata['ba_area']
            add.city = postdata['ba_city']
            add.state = postdata['ba_state']
            add.pin_zip = postdata['ba_pinzip']
            add.country = postdata['ba_country']
            add.mobile = postdata['ba_mobile']
            add.type = postdata['addressType']
            if request.POST.get('deliver'):
                add.deliver_sat = True
            else:
                add.deliver_sat = False
            if request.POST.get('same_as'):
                add.same_as_billing = True
            else:
                add.same_as_billing = False
            add.user = get_object_or_404(userDetails, id=request.session.get('site_userId'))
            add.save()
            request.session['pincode'] = postdata['ba_pinzip']
        
        elif request.POST.get('checkout') == 'Place Order':
            order = Order()
            order.payment_mode = postdata['payment_mode']
            try:
                add = get_object_or_404(Address, user=request.session.get('site_userId'))
            except:
                add = None

            # for email
            # from django.core.mail import send_mail
            # subject, from_email, to = 'hello', 'sushant@nucleusads.com', 'sushant@nucleusads.com'
            # html_content = render_to_string('ecomsite/contactus_form_email.html', locals())
            # text_content = strip_tags(html_content)
            # html_content = '<p>This is an <strong>important</strong> message.</p>'
            # msg = EmailMultiAlternatives(subject, text_content, from_email, [to])
            # msg.attach_alternative(html_content, "ecomsite/contactus_form_email.html")
            # msg.send()
            # end email

            order.address = add
            cart_calculations = user_cart.cartCalculations(self.request)
            if postdata['ba_pinzip'] != 0:
                try:
                    cart_setting_o = CartSettingOptions.objects.filter(user=getUserID()).first()
                except:
                    cart_setting_o = None
                # if  cart_setting_o is not None:   
                    # dCharges = user_cart.calculateDeliveryCharge(postdata['ba_pinzip'], cart_setting_o)
            cart_details_obj = Cart()
            order.total = cart_calculations['cart_total']
            order.final_deposite = cart_calculations['deposite_total']
            order.delivery_chgs = dCharges
            order.status = 'X'
            # vikrant 130920
            order.bust_size=cart_calculations['bust_size']
            order.waist_size=cart_calculations['waist_size']
            order.hips_size=cart_calculations['hips_size']
            # vikrant 130920
            order.tax = cart_setting_o.estimate_tax
            order.user = get_object_or_404(userDetails, id=request.session.get('site_userId'))
            order.seller = get_object_or_404(userDetails, id=getUserID())
            order.save()
            
            cartList = Cart.objects.filter(user=self.request.session.get('site_userId'))
            for cartData in cartList: 
                orderitem = OrderItem()
                orderitem.order = order
                
                currentProduct = get_object_or_404(Products, id=cartData.product.id)
                
                orderitem.product = currentProduct
                orderitem.quantity = cartData.quantity
                orderitem.booking_dt = cartData.form_date
                orderitem.delivery_dt = cartData.to_date
                orderitem.booking_days = cartData.days_index
                orderitem.subtotal = cartData.quantity * cartData.product.mrp
                orderitem.deposite=cartData.deposite

                
                currentProduct.quantity = currentProduct.quantity - cartData.quantity
               
                currentProduct.save()
                orderitem.save()
                # cartData.delete()
                # Products.objects.filter(id=postdata.get('product_id')).delete()
            if order.payment_mode == 'cod':
                ba_pinzip = request.POST['ba_pinzip']

# new added   
                try:
                    add = get_object_or_404(Address, user=request.session.get('site_userId'))
                except:
                    add = None

                order.address = add
                cart_calculations = user_cart.cartCalculations(request)
                print(cart_calculations)
                print("xcccccccccccccccccccccaaaaaaaaaaaaaaaarrrrrrrrrrrrrrrtttttt")
                if ba_pinzip != 0:
                    try:
                        cart_setting_o = CartSettingOptions.objects.filter(user=getUserID()).first()
                    except:
                        cart_setting_o = None
                    # if  cart_setting_o is not None:   
                    #      dCharges = user_cart.calculateDeliveryCharge(ba_pinzip, cart_setting_o)
                
                order.total = cart_calculations['cart_total']
                order.final_deposite = cart_calculations['deposite_total']
                # order.final_deposite = cart_calculations['deposite_total']
                # order.delivery_chgs = dCharges
                order.status = 'P'
                # vikrant 130920
                order.bust_size=cart_calculations['bust_size']
                order.waist_size=cart_calculations['waist_size']
                order.hips_size=cart_calculations['hips_size']
                # vikrant 130920
                order.tax = cart_setting_o.estimate_tax
                order.user = get_object_or_404(userDetails, id=request.session.get('site_userId'))
                order.seller = get_object_or_404(userDetails, id=getUserID())
                order.save()


                print(order.id)
                print(order.created_at)
                # print(order.product.name)
                print(order.total)
                print("INNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN")

                request.session['order_id'] = order.id
                
                cartList = Cart.objects.filter(user=request.session.get('site_userId'))
                for cartData in cartList:
                    orderitem = OrderItem()
                    orderitem.order = order
                    currentProduct = get_object_or_404(Products, id=cartData.product.id)
                    if currentProduct.isProductInStock():
                        orderitem.product = currentProduct
                        orderitem.booking_dt = cartData.form_date
                        orderitem.delivery_dt = cartData.to_date
                        orderitem.booking_days = cartData.days_index
                        orderitem.quantity = cartData.quantity
                        orderitem.subtotal = cartData.quantity * cartData.total_final_price
                        orderitem.deposite=cartData.deposite
                        
                        currentProduct.quantity = currentProduct.quantity - cartData.quantity
                        currentProduct.save()
                        orderitem.save()
                    cartData.delete()

    # new added end

                print("coddddddddddddddddddddddddddddddddddddd")
                update_order_status(order.id)
                return HttpResponseRedirect(reverse('thank_you', kwargs={'order_id': order.id}))
            else:
                print("nbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb")
                return HttpResponseRedirect(reverse('payu_payment', kwargs={'postdata': 'PayUPayment', 'order_id': order.id}))

                update_order_status(order.id)

            #     from django.core.mail import send_mail
            #     subject, from_email, to = 'hello', 'sushant@nucleusads.com', 'info@srishringarr.com'
            #     html_content = render_to_string('ecomsite/payment_success_email.html', locals())
            #     text_content = strip_tags(html_content)
            #     html_content = '<p>This is an <strong>important</strong> message.</p>'
            #     msg = EmailMultiAlternatives(subject, text_content, from_email, [to])
            #     msg.attach_alternative(html_content, "ecomsite/payment_success_email.html")
            #     msg.send()
            #     return HttpResponseRedirect(reverse('thank_you', kwargs={'order_id': order.id}))
            # else:
                
            #     from django.core.mail import send_mail
            #     subject, from_email, to = 'hello', 'sushant@nucleusads.com', 'info@srishringarr.com'
            #     html_content = render_to_string('ecomsite/payment_success_email.html', locals())
            #     text_content = strip_tags(html_content)
            #     html_content = '<p>This is an <strong>important</strong> message.</p>'
            #     msg = EmailMultiAlternatives(subject, text_content, from_email, [to])
            #     msg.attach_alternative(html_content, "ecomsite/payment_success_email.html")
            #     msg.send()
            #     return HttpResponseRedirect(reverse('payu_payment', kwargs={'postdata': 'PayUPayment', 'order_id': order.id}))
    
        if request.POST.get('searchbtn') == 'Search':
            request.session['page'] = 'home'
            try:
                strValue = postdata.get('searchtxt')
            except:
                strValue = ''
            
            if strValue == '':
                return HttpResponseRedirect(reverse('empty_search')) 
            else:        
                return HttpResponseRedirect(reverse('search', kwargs={'stxt': strValue}))
            
        responseData = super(CheckoutView, self).get(request, *args, **kwargs)     
        return  responseData 
    
    def get_context_data(self, **kwargs):
        context = super(CheckoutView, self).get_context_data(**kwargs)
        context['pageTitle'] = "Checkout Page"
        context['allStateList'] = self.allStateList
        userAdderss = Address.objects.filter(user=self.request.session.get('site_userId')).first()
        chkSetting = CheckoutPageSetting.objects.filter(user=getUserID()).first()
        context['checkout_setting'] = chkSetting
        context['cart_setting_option'] = CartSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = chkSetting.logo
        context['isTagline'] = chkSetting.headline
        context['isMenu'] = chkSetting.menu
        context['isSearchBar'] = chkSetting.searchbar
        context['isFooter'] = chkSetting.footer 
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        cartCount = 0
        #context['api_key']= RAZORPAY_INFO["api_key"]
        context['test_api_key']= RAZORPAY_INFO["test_api_key"] #####31-07-2019#########

        if self.request.session.get('site_userId') == '0' or self.request.session.get('site_userId') == None:
            cartCount = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
        else:
            cartCount = Cart.objects.filter(user=self.request.session.get('site_userId')).count()

        context['cart_count'] = cartCount

        context['add'] = userAdderss
        if userAdderss:
            self.request.session['pincode'] = userAdderss.pin_zip
            
        cart_calculations = user_cart.cartCalculations(self.request)
        context['product_total'] = cart_calculations['product_total']
        context['cart_total'] = cart_calculations['cart_total']
        # <!--  vikrant 190920-->    
        total_shipping_charge = cart_calculations['total_shipping_charge'] 
        print(total_shipping_charge)
        print(cart_calculations['total_shipping_charge'])
        context['total_shipping_charge']=total_shipping_charge
        if context['product_total'] > 5000:
            context['amount'] = cart_calculations['product_total']

        else:
            
            context['amount'] = cart_calculations['product_total'] + total_shipping_charge
        # <!--  vikrant 190920-->    
         
        # if self.request.session.get('pincode') != 0:
        #     context['distance'] = user_cart.calculateDistance(self.request.session.get('pincode'))
        #     context['delivery_charge'] = user_cart.calculateDeliveryCharge(self.request.session.get('pincode'), context['cart_setting_option'])
        context['successMessage'] = self.successMessage
        context['banklist'] = BankList.objects.all()
        context['checkout_setting_option'] = CheckoutSettingOptions.objects.filter(user=getUserID()).first()
        try:
            sellerAddress = Address.objects.filter(user=getUserID()).first() 
        except:
            sellerAddress = None
    
        context['address'] = sellerAddress
        cat_list_p = Category.objects.filter(user=getUserID(), is_active=1, parent=None)
        context['cat_list_p'] = cat_list_p
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
        return context  

    
class ThankyouView(TemplateView):
    template_name = 'ecomsite/thank_you.html'
    
    def post(self, request, *args, **kwargs):
        postdata = request.POST.copy()

# new code
        try:
            user_details = get_object_or_404(userDetails, id=request.session.get('site_userId'))
            print("emaillllllllllllllllllllllllllllllllllllllll")
            print(user_details.email)
            from django.core.mail import send_mail
            subject, from_email, to = 'hello', 'sushant@nucleusads.com', 'info@srishringarr.com'
            html_content = render_to_string('ecomsite/payment_success_email_2.html', locals())
            text_content = strip_tags(html_content)
            html_content = '<p>This is an <strong>important</strong> message.</p>'
            msg = EmailMultiAlternatives(subject, text_content, from_email, [to])
            msg.attach_alternative(html_content, "ecomsite/payment_success_email_2.html")
            msg.send()

        except:
            user_details = None
# end new code
        
        if request.POST.get('searchbtn') == 'Search':
            request.session['page'] = 'home'
            try:
                strValue = postdata.get('searchtxt')
            except:
                strValue = ''
            
            if strValue == '':
                return HttpResponseRedirect(reverse('empty_search')) 
            else:        
                return HttpResponseRedirect(reverse('search', kwargs={'stxt': strValue}))
            
        responseData = super(ThankyouView, self).get(request, *args, **kwargs)
        return responseData 
    
    def get_context_data(self, **kwargs):
        context = super(ThankyouView, self).get_context_data(**kwargs)
        context['pageTitle'] = "Thank you Page"
        self.request.session['order_id'] = ''
        thanku_setting = ThankyouPageSetting.objects.filter(user=getUserID()).first()
        context['thanku_setting_option'] = ThankUSettingOptions.objects.filter(user=getUserID()).first()
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = ''
        context['isCart'] = ''
        context['isFooter'] = '' 
        context['thanku_setting'] = thanku_setting
        context['pageTitle'] = "Thank You"
        
        order_id = self.kwargs['order_id']
        order = Order.objects.filter(id=order_id).first()
        orderProduct = OrderItem.objects.filter(order=order_id)
        context['orderItems'] = orderProduct
        context['orderData'] = order

        # <!--  vikrant 190920-->    
        cart_calculations = user_cart.cartCalculations(self.request)
        print(cart_calculations)
        print("ggggggggggggggggggggggggggggggggggggggggg")
        context['product_total'] = cart_calculations['product_total']
        context['cart_total'] = cart_calculations['cart_total']   
        total_shipping_charge = cart_calculations['total_shipping_charge'] 
        print(total_shipping_charge)
        print(cart_calculations['total_shipping_charge'])
        context['total_shipping_charge']=total_shipping_charge
        if context['product_total'] > 5000:
            context['amount'] = cart_calculations['product_total']

        else:
            
            context['amount'] = cart_calculations['product_total'] + total_shipping_charge
        # <!--  vikrant 190920--> 
            
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
        return context 

    
class AboutUsView(TemplateView):
    template_name = 'ecomsite/about_us.html'

    def post(self, request, *args, **kwargs):
        postdata = request.POST.copy()
        
        if request.POST.get('searchbtn') == 'Search':
            request.session['page'] = 'search'
            try:
                strValue = postdata.get('searchtxt')
            except:
                strValue = ''
            urlVar = '/search?stxt='+strValue
            
            if strValue == '':
                return HttpResponseRedirect(reverse('empty_search')) 
            else:
                return HttpResponseRedirect(urlVar) 
                        
        responseData = super(SearchView, self).get(request, *args, **kwargs)
        return responseData
    
    def get_context_data(self, **kwargs):
        context = super(AboutUsView, self).get_context_data(**kwargs)
        if self.request.session.get('site_userId') != '0':
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
            context['cart_list'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request))
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            context['cart_list'] = Cart.objects.filter(user=self.request.session.get('site_userId'))
         
        cart_calculations = user_cart.cartCalculations(self.request)
        context['product_total'] = cart_calculations['product_total']            
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        cat_list = Category.objects.filter(user=getUserID())
        context['cat_list'] = cat_list
        context['pageTitle'] = "About Us"
        try:
            sellerAddress = Address.objects.filter(user=getUserID()).first() 
        except:
            sellerAddress = None
    
        context['address'] = sellerAddress
        cat_list_p = Category.objects.filter(user=getUserID(), is_active=1, parent=None)
        context['cat_list_p'] = cat_list_p
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
        return context    


class TermsOfUseView(TemplateView):
    template_name = 'ecomsite/terms_of_use.html'

    def post(self, request, *args, **kwargs):
        postdata = request.POST.copy()
        
        if request.POST.get('searchbtn') == 'Search':
            request.session['page'] = 'search'
            try:
                strValue = postdata.get('searchtxt')
            except:
                strValue = ''
            urlVar = '/search?stxt='+strValue
            
            if strValue == '':
                return HttpResponseRedirect(reverse('empty_search')) 
            else:
                return HttpResponseRedirect(urlVar) 
                        
        responseData = super(SearchView, self).get(request, *args, **kwargs)
        return responseData
    
    def get_context_data(self, **kwargs):
        context = super(TermsOfUseView, self).get_context_data(**kwargs)
        if self.request.session.get('site_userId') != '0':
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
            context['cart_list'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request))
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            context['cart_list'] = Cart.objects.filter(user=self.request.session.get('site_userId'))
         
        cart_calculations = user_cart.cartCalculations(self.request)
        context['product_total'] = cart_calculations['product_total']             
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        cat_list = Category.objects.filter(user=getUserID())
        context['cat_list'] = cat_list
        context['pageTitle'] = "Terms Of Use"
        try:
            sellerAddress = Address.objects.filter(user=getUserID()).first() 
        except:
            sellerAddress = None
    
        context['address'] = sellerAddress
        cat_list_p = Category.objects.filter(user=getUserID(), is_active=1, parent=None)
        context['cat_list_p'] = cat_list_p
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
        return context   


class PrivacyPolicyView(TemplateView):
    template_name = 'ecomsite/privacy_policy.html'

    def post(self, request, *args, **kwargs):
        postdata = request.POST.copy()
        
        if request.POST.get('searchbtn') == 'Search':
            request.session['page'] = 'search'
            try:
                strValue = postdata.get('searchtxt')
            except:
                strValue = ''
            urlVar = '/search?stxt='+strValue
            
            if strValue == '':
                return HttpResponseRedirect(reverse('empty_search')) 
            else:
                return HttpResponseRedirect(urlVar) 
                        
        responseData = super(SearchView, self).get(request, *args, **kwargs)
        return responseData
    
    def get_context_data(self, **kwargs):
        context = super(PrivacyPolicyView, self).get_context_data(**kwargs)
        if self.request.session.get('site_userId') != '0':
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
            context['cart_list'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request))
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            context['cart_list'] = Cart.objects.filter(user=self.request.session.get('site_userId'))
         
        cart_calculations = user_cart.cartCalculations(self.request)
        context['product_total'] = cart_calculations['product_total']             
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        cat_list = Category.objects.filter(user=getUserID())
        context['cat_list'] = cat_list
        context['pageTitle'] = "Privacy Policy"
        try:
            sellerAddress = Address.objects.filter(user=getUserID()).first() 
        except:
            sellerAddress = None
    
        context['address'] = sellerAddress
        cat_list_p = Category.objects.filter(user=getUserID(),is_active=1, parent=None)
        context['cat_list_p'] = cat_list_p
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
        return context   
    
    
class EnquiryView(TemplateView):
    template_name = 'ecomsite/enquiry.html'
    
    def post(self, request, *args, **kwargs):
        postdata = request.POST.copy()
        if request.POST.get('send_enquiry') == 'Submit':
            support = Support()   
          
            support.fullname = postdata['e_full_name']
            support.email = postdata['e_email']
            support.mobile = postdata['e_mobile']
            support.message = postdata['e_subject']
            support.save()
      
        if request.POST.get('searchbtn') == 'Search':
            request.session['page'] = 'home'
            try:
                strValue = postdata.get('searchtxt')
            except:
                strValue = ''
            
            if strValue == '':
                return HttpResponseRedirect(reverse('empty_search')) 
            else:        
                return HttpResponseRedirect(reverse('search', kwargs={'stxt': strValue}))
            
        responseData = super(EnquiryView, self).get(request, *args, **kwargs)     
        return  responseData     
    
    def get_context_data(self, **kwargs):
        context = super(EnquiryView, self).get_context_data(**kwargs)
        if self.request.session.get('site_userId') != '0' and self.request.session.get('site_userId') != None:
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
            context['cart_list'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request))
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            context['cart_list'] = Cart.objects.filter(user=self.request.session.get('site_userId'))
         
        cart_calculations = user_cart.cartCalculations(self.request)
        context['product_total'] = cart_calculations['product_total']             
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        cat_list = Category.objects.filter(user=getUserID())
        context['cat_list'] = cat_list
        context['pageTitle'] = "Enquiry"
        try:
            sellerAddress = Address.objects.filter(user=getUserID()).first() 
        except:
            sellerAddress = None
    
        context['address'] = sellerAddress
        cat_list_p = Category.objects.filter(user=getUserID(),is_active=1, parent=None)
        context['cat_list_p'] = cat_list_p
        
        if self.request.session.get('site_userId') != '0' and self.request.session.get('site_userId') != None:
            userData = get_object_or_404(userDetails, id=self.request.session.get('site_userId'))
            context['userData'] = userData
        else:
            context['userData'] = ''  
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username  
        return context   
    
    
class TakeATourView(TemplateView):
    template_name = 'ecomsite/take_a_tour.html'
    
    def get_context_data(self, **kwargs):
        context = super(TakeATourView, self).get_context_data(**kwargs)
        if self.request.session.get('site_userId') != '0':
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        cat_list = Category.objects.filter(user=getUserID())
        context['cat_list'] = cat_list        
        context['pageTitle'] = "Take A Tour"
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
        return context               

    
class FaqsView(TemplateView):
    template_name = 'ecomsite/faqs.html'

    def post(self, request, *args, **kwargs):
        postdata = request.POST.copy()
        
        if request.POST.get('searchbtn') == 'Search':
            request.session['page'] = 'search'
            try:
                strValue = postdata.get('searchtxt')
            except:
                strValue = ''
            urlVar = '/search?stxt='+strValue
            
            if strValue == '':
                return HttpResponseRedirect(reverse('empty_search')) 
            else:
                return HttpResponseRedirect(urlVar) 
                        
        responseData = super(SearchView, self).get(request, *args, **kwargs)
        return responseData
    
    def get_context_data(self, **kwargs):
        context = super(FaqsView, self).get_context_data(**kwargs)
        if self.request.session.get('site_userId') != '0':
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        cat_list = Category.objects.filter(user=getUserID())
        context['cat_list'] = cat_list        
        context['pageTitle'] = "FAQs"
        cat_list_p = Category.objects.filter(user=getUserID(),is_active=1, parent=None)
        context['cat_list_p'] = cat_list_p
        try:
            sellerAddress = Address.objects.filter(user=getUserID()).first() 
        except:
            sellerAddress = None
    
        context['address'] = sellerAddress
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
        return context       


class ContactUsView(TemplateView):
    template_name = 'ecomsite/contact_us.html'

    def post(self, request, *args, **kwargs):
        postdata = request.POST.copy()
        if request.POST.get('send_enquiry') == 'Submit':
            visitors = VisitorFormDetail()   
          
            visitors.fullname = postdata['e_full_name']
            visitors.email = postdata['e_email']
            visitors.mobile = postdata['e_mobile']
            visitors.message = postdata['e_subject']
            visitors.save()

            visitorsObj = VisitorFormDetail.objects.filter().last()


            # send_feedback_email_task.delay(name,email,msg)
            from django.core.mail import send_mail
            subject, from_email, to = 'hello', 'info@srishringarr.com', 'info@srishringarr.com'
            html_content = render_to_string('ecomsite/contactus_form_email.html', locals())
            text_content = strip_tags(html_content)
            html_content = '<p>This is an <strong>important</strong> message.</p>'
            msg = EmailMultiAlternatives(subject, text_content, from_email, [to])
            msg.attach_alternative(html_content, "ecomsite/contactus_form_email.html")
            msg.send()

        if request.POST.get('searchbtn') == 'Search':
            request.session['page'] = 'search'
            try:
                strValue = postdata.get('searchtxt')
            except:
                strValue = ''
            urlVar = '/search?stxt='+strValue
            
            if strValue == '':
                return HttpResponseRedirect(reverse('empty_search')) 
            else:
                return HttpResponseRedirect(urlVar) 
                        
        responseData = super(ContactUsView, self).get(request, *args, **kwargs)
        return responseData
      
        # if request.POST.get('searchbtn') == 'Search':
        #     request.session['page'] = 'home'
        #     try:
        #         strValue = postdata.get('searchtxt')
        #     except:
        #         strValue = ''
            
        #     if strValue == '':
        #         return HttpResponseRedirect(reverse('empty_search')) 
        #     else:        
        #         return HttpResponseRedirect(reverse('search', kwargs={'stxt': strValue}))
            
        # responseData = super(ContactUsView, self).get(request, *args, **kwargs)     
        # return  responseData
    
    def get_context_data(self, **kwargs):
        context = super(ContactUsView, self).get_context_data(**kwargs)
        if self.request.session.get('site_userId') != '0':
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
            context['cart_list'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request))
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            context['cart_list'] = Cart.objects.filter(user=self.request.session.get('site_userId'))
         
        cart_calculations = user_cart.cartCalculations(self.request)
        context['product_total'] = cart_calculations['product_total']          
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        cat_list = Category.objects.filter(user=getUserID())
        context['cat_list'] = cat_list
        context['pageTitle'] = "Contact Us"
        cat_list_p = Category.objects.filter(user=getUserID(),is_active=1, parent=None)
        context['cat_list_p'] = cat_list_p
        try:
            sellerAddress = Address.objects.filter(user=getUserID()).first() 
        except:
            sellerAddress = None
    
        context['address'] = sellerAddress
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
        return context   

    
class UserProfileView(TemplateView):
    template_name = 'ecomsite/user_profile.html'
    
    def get_context_data(self, **kwargs):
        context = super(UserProfileView, self).get_context_data(**kwargs)
        if self.request.session.get('site_userId') != '0':
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
            context['cart_list'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request))
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            context['cart_list'] = Cart.objects.filter(user=self.request.session.get('site_userId'))
         
        cart_calculations = user_cart.cartCalculations(self.request)
        context['product_total'] = cart_calculations['product_total']          
        
        context['user_details'] = userDetails.objects.filter(id=self.request.session.get('site_userId')).first()
        context['user_address'] = Address.objects.filter(user_id=self.request.session.get('site_userId'))
        context['wishlist_count'] = AddtoWishlist.objects.filter(user_id=self.request.session.get('site_userId')).count()
        context['total_order_count'] = Order.objects.filter(user=self.request.session.get('site_userId')).count()
        context['pending_order_count'] = Order.objects.filter(status="P", user=self.request.session.get('site_userId')).count()
        context['confirm_order_count'] = Order.objects.filter(status="C", user=self.request.session.get('site_userId')).count()
        context['cancel_order_count'] = Order.objects.filter(status="X", user=self.request.session.get('site_userId')).count()
        
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        cat_list = Category.objects.filter(user=getUserID())
        context['cat_list'] = cat_list
        context['pageTitle'] = "User Profile"
        cat_list_p = Category.objects.filter(user=getUserID(),is_active=1, parent=None)
        context['cat_list_p'] = cat_list_p
        try:
            sellerAddress = Address.objects.filter(user=getUserID()).first() 
        except:
            sellerAddress = None
    
        context['address'] = sellerAddress
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
        return context      

    
class NotificationView(TemplateView):
    template_name = 'ecomsite/notification.html'
    
    def get_context_data(self, **kwargs):
        context = super(NotificationView, self).get_context_data(**kwargs)
        if self.request.session.get('site_userId') != '0':
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        cat_list = Category.objects.filter(user=getUserID())
        context['cat_list'] = cat_list
        context['pageTitle'] = "Notifications"
        return context         


class LoginView(TemplateView):
    template_name = 'ecomsite/login.html'
    strMessage = ''
    responseStatus = False
    
    def post(self, request, *args, **kwargs):
        userAllData = userDetails.objects.filter(Q(email=request.POST['username']) | Q(password=make_password(request.POST['password'])))
        if userAllData:
            userdata = userDetails.objects.filter(email=request.POST['username']).first()
            self.strMessage = "Logged in Successfully"
            self.responseStatus = True
            request.session['site_isUserLogin'] = True
            request.session['site_userId'] = userdata.id
            cartList = Cart.objects.filter(cart_id=user_cart._cart_id(self.request))
            if cartList:
                user_cart.update_userid_in_cart_login(self.request)
            return HttpResponseRedirect(reverse('site_home'))
        else:
            self.strMessage = "Do not have an account?"
            self.responseStatus = False
            request.session['site_isUserLogin'] = False
            request.session['site_userId'] = '0'
            
        rseponseData = super(LoginView, self).get(request, *args, **kwargs)  
        return rseponseData
    
    def get_context_data(self, **kwargs):
        context = super(LoginView, self).get_context_data(**kwargs)
        self.request.session['pincode'] = 0
        context['successMessage'] = self.strMessage
        context['pageTitle'] = "Login"
        context['status'] = self.responseStatus
        if self.request.session.get('site_userId') != '0':
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        cat_list = Category.objects.filter(user=getUserID())
        context['cat_list'] = cat_list
        return context  

    
class SignUPView(TemplateView):
    template_name = 'ecomsite/signup.html'
    strMessage = ''
    responseStatus = False

    def post(self, request, *args, **kwargs):
        isValid = True
        emailID = request.POST['userEmailId'].strip()
        mobileNumber = request.POST['userMobile'].strip()
        userAllData = userDetails.objects.filter(Q(email=emailID) | Q(mobile=mobileNumber))
        userMerchant = userDetails.objects.filter(Q(email=emailID) | Q(mobile=mobileNumber), user_group=0)
            
        if userAllData:
            if userMerchant:
                self.strMessage = "User already present as merchant. Please Login"
            else:
                self.strMessage = "User already present. Please Login"
            isValid = False
        else:
            if True  if request.POST['userName'].strip() == '' else False :
                self.strMessage = "Enter user name."
                isValid = False
            elif True  if request.POST['userPassword'].strip() == '' else False :
                self.strMessage = "Password required"
                isValid = False
            elif True  if request.POST['userMobile'].strip() == '' else False :
                self.strMessage = "Enter valid mobile number"
                isValid = False
            elif True  if request.POST['userEmailId'].strip() == '' else False :
                self.strMessage = "Enter valid email address"
                isValid = False
            
        if isValid:
            userData = userDetails()
            userData.username = request.POST['userName']
            userData.password = make_password(request.POST['userPassword'])
            userData.mobile = request.POST['userMobile']
            userData.email = request.POST['userEmailId']
            userData.user_group = 1
            userData.save() 
            self.strMessage = "Account created Successfully"
            self.responseStatus = True
            return HttpResponseRedirect(reverse('site_login'))

        rseponseData = super(SignUPView, self).get(request, *args, **kwargs)     
        return  rseponseData 

    def get_context_data(self, **kwargs):
        context = super(SignUPView, self).get_context_data(**kwargs)
        context['successMessage'] = self.strMessage
        context['status'] = self.responseStatus
        context['pageTitle'] = "Sign Up"
        if self.request.session.get('site_userId') == '0' or self.request.session.get('site_userId') == None:
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        cat_list = Category.objects.filter(user=getUserID())
        context['cat_list'] = cat_list
        return context

    
def add_to_wishlist(request):
    postdata = request.POST.copy()
    response = ''
    
    if request.session.get('site_userId') == '0' or request.session.get('site_userId') == None:
        response = {
            'success' : 'False',
            'strMsg' : 'Please login to proceed!',
        }
    else:
        try:
            wishlist = get_object_or_404(AddtoWishlist, product_id=postdata.get('product_id'), user_id=request.session.get('site_userId'))
        except:
            wishlist = None
            
        if wishlist is not None:
            AddtoWishlist.objects.filter(product_id=postdata.get('product_id'), user_id=request.session.get('site_userId')).delete()
            response = {
                'success' : 'True',
                'strMsg' : 'Product removed from wishlist',
            }
        else:
            wishlist = AddtoWishlist()
            wishlist.product = get_object_or_404(Products, id=postdata.get('product_id'))
            wishlist.user = get_object_or_404(userDetails, id=request.session.get('site_userId'))
            wishlist.save()
             
            response = {
                'success' : 'True',
                'strMsg' : 'Product added to wishlist',
            }
    return JsonResponse(response)


class WishListView(TemplateView):
    template_name = 'ecomsite/wishlist.html'
    
    def post(self, request, *args, **kwargs):
        postdata = request.POST.copy()
        
        if postdata['clear_wishlist'] == 'Clear Wishlist':
            AddtoWishlist.objects.filter(user_id=request.session.get('site_userId')).delete()
            
        responseData = super(WishListView, self).get(request, *args, **kwargs)
        return responseData
    
    def get_context_data(self, **kwargs):
        context = super(WishListView, self).get_context_data(**kwargs)
        if self.request.session.get('site_userId') != '0':
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
            context['cart_list'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request))
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            context['cart_list'] = Cart.objects.filter(user=self.request.session.get('site_userId'))
         
        cart_calculations = user_cart.cartCalculations(self.request)
        context['product_total'] = cart_calculations['product_total']
        wishlist = AddtoWishlist.objects.filter(user=self.request.session.get('site_userId'))
        
        board = []
        for w in wishlist:
            board.append(w.product.id)
        productList = board
        context['wishlist'] = wishlist
        context['product_list'] = Products.objects.filter(id__in=productList, is_active=True, is_delete=False, user=getUserID())
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        context['pageTitle'] = "Wish List"
        cat_list = Category.objects.filter(user=getUserID())
        context['cat_list'] = cat_list
        cat_list_p = Category.objects.filter(user=getUserID(),is_active=1, parent=None)
        context['cat_list_p'] = cat_list_p
        try:
            sellerAddress = Address.objects.filter(user=getUserID()).first() 
        except:
            sellerAddress = None
    
        context['address'] = sellerAddress
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
        return context

    
class OrderListView(TemplateView):
    template_name = 'ecomsite/orders.html'
    
    def get_context_data(self, **kwargs):
        context = super(OrderListView, self).get_context_data(**kwargs)
        order = Order.objects.filter(user=self.request.session.get('site_userId'))
        orderid = []
        for data in order:
            orderid.append(data.id)

        user = self.request.session.get('site_userId')

        order_detail_dict = {}
            
        context['order_item_list'] = OrderItem.objects.filter(order__in=(orderid))
        order_detail_dict['order_detail'], order_detail_dict['order_detail_report'] = 0, ""

        if len(orderid) > 0:
            orderIds = ",".join(map(str,orderid))

        cursor = connection.cursor()

        cursor.execute(''' SELECT oi.order_id, prd.name, prd.product_image, oi.quantity, oi.subtotal, ord.status,ord.deposite_collect,ord.deposite_return,ord.final_deposite
                        FROM `order_items` as oi 
                        LEFT JOIN `orders` as ord ON ord.id = oi.order_id
                        LEFT JOIN `products` as prd ON oi.product_id = prd.id
                        WHERE ord.id IN ({0}) AND {1}
                        ORDER BY oi.id DESC'''.format(orderIds,user))
        orderDetailObj = dictfetchall(cursor)

        if len(orderDetailObj) > 0:
            order_detail_dict['order_detail'] = len(orderDetailObj)

            tmp_list, tmp_dict = [], {}
            for res in orderDetailObj:
                tmp_dict['order_id'] = res['order_id']
                tmp_dict['product_name'] = res['name']
                tmp_dict['product_image'] = res['product_image']
                tmp_dict['product_quantity'] = res['quantity']
                tmp_dict['subtotal'] = res['subtotal']
                tmp_dict['order_status'] = res['status']
                tmp_dict['deposit_collect'] = res['deposite_collect']
                tmp_dict['deposit_return'] = res['deposite_return']
                tmp_dict['final_deposite'] = res['final_deposite']
                tmp_list.append(tmp_dict.copy())

        context['order_detail_report'] = tmp_list
            
        context['order_item_list'] = OrderItem.objects.filter(order__in=(orderid))
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        context['pageTitle'] = "My Orders"
        cat_list = Category.objects.filter(user=getUserID())
        context['cat_list'] = cat_list        
        if self.request.session.get('site_userId') != '0':
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
            context['cart_list'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request))
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            context['cart_list'] = Cart.objects.filter(user=self.request.session.get('site_userId'))
         
        cart_calculations = user_cart.cartCalculations(self.request)
        context['product_total'] = cart_calculations['product_total']
   
        cat_list_p = Category.objects.filter(user=getUserID(),is_active=1, parent=None)
        context['cat_list_p'] = cat_list_p
        try:
            sellerAddress = Address.objects.filter(user=getUserID()).first() 
        except:
            sellerAddress = None
    
        context['address'] = sellerAddress
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
        return context

    
class OrderDetailsView(TemplateView):
    template_name = 'ecomsite/order_details.html'
    
    def post(self, request, *args, **kwargs):
        postdata = request.POST.copy()
        
        if request.POST.get('searchbtn') == 'Search':
            request.session['page'] = 'home'
            try:
                strValue = postdata.get('searchtxt')
            except:
                strValue = ''
            
            if strValue == '':
                return HttpResponseRedirect(reverse('empty_search')) 
            else:        
                return HttpResponseRedirect(reverse('search', kwargs={'stxt': strValue}))
            
        responseData = super(OrderDetailsView, self).get(request, *args, **kwargs)
        return responseData 
    
    def get_context_data(self, **kwargs):
        context = super(OrderDetailsView, self).get_context_data(**kwargs)
        thanku_setting = ThankyouPageSetting.objects.filter(user=getUserID()).first()
        context['thanku_setting_option'] = ThankUSettingOptions.objects.filter(user=getUserID()).first()
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        context['thanku_setting'] = thanku_setting
        context['pageTitle'] = "Order Details"
        
        order_id = self.kwargs['order_id']
        order = Order.objects.filter(id=order_id).first()
        orderProduct = OrderItem.objects.filter(order=order_id)
        context['orderItems'] = orderProduct
        context['orderData'] = order
        cat_list = Category.objects.filter(user=getUserID())
        context['cat_list'] = cat_list        
        if self.request.session.get('site_userId') != '0':
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
            context['cart_list'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request))
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            context['cart_list'] = Cart.objects.filter(user=self.request.session.get('site_userId'))
         
        cart_calculations = user_cart.cartCalculations(self.request)
        context['product_total'] = cart_calculations['product_total']
        
        cat_list_p = Category.objects.filter(user=getUserID(),is_active=1, parent=None)
        context['cat_list_p'] = cat_list_p
        try:
            sellerAddress = Address.objects.filter(user=getUserID()).first() 
        except:
            sellerAddress = None
    
        context['address'] = sellerAddress
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
        
        return context 


class TrackOrderView(TemplateView):
    template_name = 'ecomsite/track_order.html'
    
    def get_context_data(self, **kwargs):
        context = super(TrackOrderView, self).get_context_data(**kwargs)
        wishlist = AddtoWishlist.objects.filter(user=self.request.session.get('site_userId'))
        
        board = []
        for w in wishlist:
            board.append(w.product.id)
        productList = board
        
        context['product_list'] = Products.objects.filter(id__in=productList, is_active=True, is_delete=False, user=getUserID())
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        context['pageTitle'] = "Track My Orders"
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
        return context    

class ShipReturnCancel(TemplateView):
    template_name = 'ecomsite/Shipping,Cancellation&Returns.html'

    def post(self, request, *args, **kwargs):
        postdata = request.POST.copy()
        
        if request.POST.get('searchbtn') == 'Search':
            request.session['page'] = 'search'
            try:
                strValue = postdata.get('searchtxt')
            except:
                strValue = ''
            urlVar = '/search?stxt='+strValue
            
            if strValue == '':
                return HttpResponseRedirect(reverse('empty_search')) 
            else:
                return HttpResponseRedirect(urlVar) 
                        
        responseData = super(SearchView, self).get(request, *args, **kwargs)
        return responseData
    
    def get_context_data(self, **kwargs):
        context = super(ShipReturnCancel, self).get_context_data(**kwargs)
        if self.request.session.get('site_userId') != '0':
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
            context['cart_list'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request))
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            context['cart_list'] = Cart.objects.filter(user=self.request.session.get('site_userId'))
         
        cart_calculations = user_cart.cartCalculations(self.request)
        context['product_total'] = cart_calculations['product_total']             
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        cat_list = Category.objects.filter(user=getUserID())
        context['cat_list'] = cat_list
        context['pageTitle'] = "ShipReturnCancel"
        try:
            sellerAddress = Address.objects.filter(user=getUserID()).first() 
        except:
            sellerAddress = None
    
        context['address'] = sellerAddress
        cat_list_p = Category.objects.filter(user=getUserID(),is_active=1, parent=None)
        context['cat_list_p'] = cat_list_p
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
        return context   

class SearchView(TemplateView):
    template_name = 'ecomsite/search.html'
    
    def post(self, request, *args, **kwargs):
        postdata = request.POST.copy()
        
        if request.POST.get('searchbtn') == 'Search':
            request.session['page'] = 'search'
            try:
                strValue = postdata.get('searchtxt')
            except:
                strValue = ''
            urlVar = '/search?stxt='+strValue
            
            if strValue == '':
                return HttpResponseRedirect(reverse('empty_search')) 
            else:
                return HttpResponseRedirect(urlVar) 
                        
        responseData = super(SearchView, self).get(request, *args, **kwargs)
        return responseData
        
    def get_context_data(self, **kwargs):
        context = super(SearchView, self).get_context_data(**kwargs)
        try:
            stxt = self.request.GET.get('stxt')
        except:
            stxt = ''    
                
#         rtxt = stxt.strip().replace("'", "")
#         matchtxt = _prepare_words(rtxt)
#         newtxt1 = (" ".join(str(x) for x in matchtxt))
#         newtxt = newtxt1.strip("!@#$%^&*()|?")
        context['result'] = searchTxt(self.request, stxt)
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        context['pageTitle'] = "Search"
        cat_list = Category.objects.filter(is_active=True, user=getUserID())
        context['cat_list'] = cat_list
        cat_list_p = Category.objects.filter(is_active=1, user=getUserID(), parent=None)
        context['cat_list_p'] = cat_list_p
        try:
            sellerAddress = Address.objects.filter(user=getUserID()).first() 
        except:
            sellerAddress = None
    
        context['address'] = sellerAddress
        if self.request.session.get('site_userId') != '0':
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
            context['cart_list'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request))
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
            context['cart_list'] = Cart.objects.filter(user=self.request.session.get('site_userId'))
         
        cart_calculations = user_cart.cartCalculations(self.request)
        context['product_total'] = cart_calculations['product_total']
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username          

        return context


def searchTxt(request, newtxt):
    search_dict = {}
    if newtxt:
        cursor = connection.cursor()
        if request.session.get('page') == 'home' or request.session.get('page') == 'search' or request.session.get('page') == 'cart' or request.session.get('page') == 'checkout':
            homeOptions = get_object_or_404(HomeSettingOptions, user_id=getUserID())
            if homeOptions.search_options == "1" or homeOptions.search_options == "1, 2, 3, 4, 5, 6" or homeOptions.search_options == "2, 3, 4, 5, 6":
                searchBy = 'all'
            elif homeOptions.search_options == "2":
                searchBy = '2'
            elif homeOptions.search_options == "3":
                searchBy = '3'
            elif homeOptions.search_options == "4":
                searchBy = '4'
            elif homeOptions.search_options == "5":
                searchBy = '5'
            elif homeOptions.search_options == "6":
                searchBy = '6'
        elif request.session.get('page') == 'prolist':
            prolistOptions = get_object_or_404(ProductListSettingOptions, user_id=getUserID())
            if prolistOptions.search_options == "1" or homeOptions.search_options == "1, 2, 3, 4, 5, 6" or homeOptions.search_options == "2, 3, 4, 5, 6":
                searchBy = 'all'
            elif prolistOptions.search_options == "2":
                searchBy = '2'
            elif prolistOptions.search_options == "3":
                searchBy = '3'
            elif prolistOptions.search_options == "4":
                searchBy = '4'
            elif prolistOptions.search_options == "5":
                searchBy = '5'
            elif prolistOptions.search_options == "6":
                searchBy = '6'
        elif request.session.get('page') == 'prodetails':
            prodetailsOptions = get_object_or_404(PDSettingOptions, user_id=getUserID())
            if prodetailsOptions.search_options == "1" or homeOptions.search_options == "1, 2, 3, 4, 5, 6" or homeOptions.search_options == "2, 3, 4, 5, 6":
                searchBy = 'all'
            elif prodetailsOptions.search_options == "2":
                searchBy = '2'
            elif prodetailsOptions.search_options == "3":
                searchBy = '3'
            elif prodetailsOptions.search_options == "4":
                searchBy = '4'
            elif prodetailsOptions.search_options == "5":
                searchBy = '5'
            elif prodetailsOptions.search_options == "6":
                searchBy = '6'
            
        if searchBy == "all":
            search_dict['display'] = 0
            cursor.execute(''' SELECT * FROM `categories` AS c 
                            WHERE c.user_id = {0} AND c.is_active = 1 AND (c.name LIKE '%{1}%' OR c.slug LIKE '%{1}%' OR c.description LIKE '%{1}%' OR c.meta_keywords LIKE '%{1}%' OR c.meta_description LIKE '%{1}%') '''.format(getUserID(), newtxt))
            search_dict['category_list'] = dictfetchall(cursor)
            
            cursor.execute(''' SELECT * FROM `products` AS p 
                            WHERE p.user_id = {0} AND p.is_active = 1 AND (p.name LIKE '%{1}%' OR p.slug LIKE '%{1}%' OR p.sku LIKE '%{1}%' OR p.small_description LIKE '%{1}%' OR p.description LIKE '%{1}%' OR p.specific_for LIKE '%{1}%' OR p.brand LIKE '%{1}%' OR p.size LIKE '%{1}%' OR p.highlights LIKE '%{1}%' OR p.services LIKE '%{1}%' OR p.specifications LIKE '%{1}%' OR p.meta_keywords LIKE '%{1}%' OR p.meta_description LIKE '%{1}%') '''.format(getUserID(), newtxt))
            search_dict['product_list'] = dictfetchall(cursor)
            
            cursor.execute(''' SELECT * FROM `offer_details` AS o 
                            WHERE o.user_id = {0} AND o.is_active = 1 AND (o.offer_name LIKE '%{1}%' OR o.offer_code LIKE '%{1}%' OR o.offer_slug LIKE '%{1}%' OR o.seller_ref_code LIKE '%{1}%' OR o.description LIKE '%{1}%' OR o.short_description LIKE '%{1}%' OR o.terms_condition LIKE '%{1}%') '''.format(getUserID(), newtxt))
            search_dict['offer_list'] = dictfetchall(cursor)
            
            search_dict['cat_count'] = len(search_dict['category_list'])
            search_dict['prod_count'] = len(search_dict['product_list'])
            search_dict['offer_count'] = len(search_dict['offer_list'])
        elif searchBy == "2":
            search_dict['display'] = 1
            cursor.execute(''' SELECT * FROM `products` AS p 
                            WHERE p.user_id = {0} AND p.is_active = 1 AND (p.name LIKE '%{1}%' OR p.slug LIKE '%{1}%' OR p.sku LIKE '%{1}%' OR p.small_description LIKE '%{1}%' OR p.description LIKE '%{1}%' OR p.specific_for LIKE '%{1}%' OR p.brand LIKE '%{1}%' OR p.size LIKE '%{1}%' OR p.highlights LIKE '%{1}%' OR p.services LIKE '%{1}%' OR p.specifications LIKE '%{1}%' OR p.meta_keywords LIKE '%{1}%' OR p.meta_description LIKE '%{1}%') '''.format(getUserID(), newtxt))
            search_dict['product_list'] = dictfetchall(cursor)
            search_dict['prod_count'] = len(search_dict['product_list'])
        elif searchBy == "3":
            search_dict['display'] = 1
            cursor.execute(''' SELECT * FROM `products` AS p 
                            WHERE p.user_id = {0} AND p.is_active = 1 AND p.discount != 0 AND (p.name LIKE '%{1}%' OR p.slug LIKE '%{1}%' OR p.sku LIKE '%{1}%' OR p.small_description LIKE '%{1}%' OR p.description LIKE '%{1}%' OR p.specific_for LIKE '%{1}%' OR p.brand LIKE '%{1}%' OR p.size LIKE '%{1}%' OR p.highlights LIKE '%{1}%' OR p.services LIKE '%{1}%' OR p.specifications LIKE '%{1}%' OR p.meta_keywords LIKE '%{1}%' OR p.meta_description LIKE '%{1}%') '''.format(getUserID(), newtxt))
            search_dict['product_list'] = dictfetchall(cursor)
            search_dict['prod_count'] = len(search_dict['product_list'])
        elif searchBy == "4":
            search_dict['display'] = 2
            cursor.execute(''' SELECT * FROM `categories` AS c 
                            WHERE c.user_id = {0} AND c.is_active = 1 AND (c.name LIKE '%{1}%' OR c.slug LIKE '%{1}%' OR c.description LIKE '%{1}%' OR c.meta_keywords LIKE '%{1}%' OR c.meta_description LIKE '%{1}%') '''.format(getUserID(), newtxt))
            search_dict['category_list'] = dictfetchall(cursor)
            search_dict['cat_count'] = len(search_dict['category_list'])
        elif searchBy == "5":
            search_dict['display'] = 3
            cursor.execute(''' SELECT * FROM `offer_details` AS o 
                            WHERE o.user_id = {0} AND o.is_active = 1 AND (o.offer_name LIKE '%{1}%' OR o.offer_code LIKE '%{1}%' OR o.offer_slug LIKE '%{1}%' OR o.seller_ref_code LIKE '%{1}%' OR o.description LIKE '%{1}%' OR o.short_description LIKE '%{1}%' OR o.terms_condition LIKE '%{1}%') '''.format(getUserID(), newtxt))
            search_dict['offer_list'] = dictfetchall(cursor)
            search_dict['offer_count'] = len(search_dict['offer_list'])
        elif searchBy == "6":
            search_dict['display'] = 1
            cursor.execute(''' SELECT * FROM `products` AS p 
                            WHERE p.user_id = {0} AND p.is_active = 1 AND (p.brand LIKE '%{1}%') '''.format(getUserID(), newtxt))
            search_dict['product_list'] = dictfetchall(cursor)
            search_dict['prod_count'] = len(search_dict['product_list'])
        else:
            search_dict['cat_count'] = 0
            search_dict['prod_count'] = 0
            search_dict['offer_count'] = 0
    else:
        search_dict = []
        
    return search_dict


class EditProfileView(TemplateView):
    template_name = 'ecomsite/edit_profile.html'
    
    def post(self, request, *args, **kwargs):
        postdata = request.POST.copy()
        
        if postdata['edit_profile'] == 'Save':
            try:
                user_details = get_object_or_404(userDetails, id=self.request.session.get('site_userId'))
            except:
                user_details = None
        if user_details != None:
            user_details.full_name = postdata.get('fullname')
            user_details.mobile = postdata.get('mobile')
            user_details.password = make_password(request.POST['userPassword'])
            user_details.save()
            return HttpResponseRedirect(reverse('user_profile'))
            
        responseData = super(EditProfileView, self).get(request, *args, **kwargs)
        return responseData
    
    def get_context_data(self, **kwargs):
        context = super(EditProfileView, self).get_context_data(**kwargs)
        if self.request.session.get('site_userId') != '0':
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count()
        else:
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count()
        
        context['user_details'] = userDetails.objects.filter(id=self.request.session.get('site_userId')).first()
        
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        cat_list = Category.objects.filter(user=getUserID())
        context['cat_list'] = cat_list
        context['pageTitle'] = "User Profile"
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
        return context


class AddressView(TemplateView):
    template_name = 'ecomsite/address.html'

    def post(self, request, *args, **kwargs):
        postdata = request.POST.copy()
        aid = kwargs['address_id']
        if aid == '0':
            addressObj = Address()
        else:
            addressObj = get_object_or_404(Address, id=aid)
        
        addressObj.name = postdata.get('ba_full_name')
        addressObj.address = postdata.get('ba_address')
        addressObj.area = postdata.get('ba_area')
        addressObj.city = postdata.get('ba_city')
        addressObj.state = postdata.get('ba_state')
        addressObj.pin_zip = postdata.get('ba_pinzip')
        addressObj.country = postdata.get('ba_country')
        addressObj.mobile = postdata.get('ba_mobile')
        addressObj.type = postdata.get('addressType')
        if request.POST.get('deliver'):
            addressObj.deliver_sat = True
        else:
            addressObj.deliver_sat = False
        addressObj.user = get_object_or_404(userDetails, id=request.session.get('site_userId'))
        addressObj.save()
        return HttpResponseRedirect(reverse('user_profile'))
        
        responseData = super(AddressView, self).get(request, *args, **kwargs)     
        return  responseData    
    
    def get_context_data(self, **kwargs):
        context = super(AddressView, self).get_context_data(**kwargs)
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
        aid = self.kwargs['address_id']
        
        if aid != '0':
            context['address'] = get_object_or_404(Address, id=aid)
        else:
            context['address'] = ''
        
        context['home_setting'] = homeSettng
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first()
        context['isLogo'] = homeSettng.logo
        context['isTagline'] = homeSettng.headline
        context['isMenu'] = homeSettng.menu
        context['isSearchBar'] = homeSettng.searchbar
        context['isCart'] = homeSettng.cart_symbol
        context['isFooter'] = homeSettng.footer 
        context['allStateList'] = StateList.objects.all()
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
        return context

    
def payUpayment(request, postdata, order_id):
    posted = {}
    order_info = Order.objects.latest('id')
    for i in request.POST:
        posted[i] = request.POST[i]
    
    ts = int(time.time())  
    txnid = str(ts) + "XX" + str(order_id)
    hashh = ''
    order_info.txnid = txnid
    order_info.save()
    request.session['order_id'] = order_id
    posted['txnid'] = order_info.txnid
    hashSequence = "key|txnid|amount|productinfo|firstname|email|udf1|udf2|udf3|udf4|udf5|udf6|udf7|udf8|udf9|udf10"
    posted['key'] = PAYU_INFO.get('merchant_key')
    posted['amount'] = order_info.total
    posted['firstname'] = order_info.address.name
    posted['email'] = order_info.user.email
    posted['phone'] = order_info.address.mobile
    posted['productinfo'] = order_info.user
    posted['surl'] = PAYU_INFO.get('success_url')
    posted['furl'] = PAYU_INFO.get('failuer_url')
        
    hash_string = ''
    hashVarsSeq = hashSequence.split('|')
    print("******************")
    print(hashVarsSeq)
    print("******************")
    for i in hashVarsSeq:
        try:
            hash_string += str(posted[i])
        except Exception:
            hash_string += ''
        hash_string += '|'
    hash_string += PAYU_INFO.get('merchant_salt')
    hashh = hashlib.sha512(hash_string.encode(encoding='utf_8', errors='strict')).hexdigest().lower()
    action = PAYU_INFO.get('payment_url')
    if(posted.get("key") != None and posted.get("txnid") != None and posted.get("productinfo") != None and posted.get("firstname") != None and posted.get("email") != None):
        return render(request, 'PayU/payUform.html', {"posted":posted,
                                                                                  "hashh":hashh, "MERCHANT_KEY":PAYU_INFO.get('merchant_key'),
                                                                                  "txnid":txnid, "hash_string":hash_string,
                                                                                  "action":action
                                                                                  })
    else:
        return render(request, 'PayU/payUform.html', {"posted":posted, "hashh":hashh, "MERCHANT_KEY":PAYU_INFO.get('merchant_key'), "txnid":txnid, "hash_string":hash_string, "action":"." })


@csrf_protect

@csrf_exempt
def success(request):
    status = request.POST["status"]
    firstname = request.POST["firstname"]
    amount = request.POST["amount"]
    txnid = request.POST["txnid"]
    posted_hash = request.POST["hash"]
    key = request.POST["key"]
    productinfo = request.POST["productinfo"]
    email = request.POST["email"]
    salt = PAYU_INFO.get('merchant_salt')
    try:
        additionalCharges = request.POST["additionalCharges"]
        retHashSeq = additionalCharges + '|' + salt + '|' + status + '|||||||||||' + email + '|' + firstname + '|' + productinfo + '|' + amount + '|' + txnid + '|' + key
    except Exception:
        retHashSeq = salt + '|' + status + '|||||||||||' + email + '|' + firstname + '|' + productinfo + '|' + amount + '|' + txnid + '|' + key
    hashh = hashlib.sha512(retHashSeq.encode(encoding='utf_8', errors='strict')).hexdigest().lower()
    if(hashh != posted_hash):
        print ("Invalid Transaction. Please try again")
    else:
        
        try:
            check_txnid = get_object_or_404(Order, user_id=request.session.get('site_userId'), txnid=txnid)
        except:
            check_txnid = None
        if check_txnid == None:    
            update_order_status(request.session.get('order_id'))
        print ("Thank You. Your order status is ", status)
        print ("Your Transaction ID for this transaction is ", txnid)
        print ("We have received a payment of Rs. ", amount , ". Your order will soon be shipped.")
    return HttpResponseRedirect(reverse('thank_you', kwargs={'order_id': request.session.get('order_id')}))


@csrf_protect
@csrf_exempt
def failure(request):
    c = {}
    dataValue = 'this is data'
    status = request.POST["status"]
    firstname = request.POST["firstname"]
    amount = request.POST["amount"]
    txnid = request.POST["txnid"]
    posted_hash = request.POST["hash"]
    key = request.POST["key"]
    productinfo = request.POST["productinfo"]
    email = request.POST["email"]
    salt = PAYU_INFO.get('merchant_salt')
    homeSettng = HomeSetting.objects.filter(user=getUserID()).first()
    home_setting = homeSettng
    home_seting_option = HomeSettingOptions.objects.filter(user=getUserID()).first()
    isLogo = homeSettng.logo
    isTagline = homeSettng.headline
    isMenu = homeSettng.menu
    isSearchBar = homeSettng.searchbar
    isCart = homeSettng.cart_symbol
    isFooter = homeSettng.footer 
    allStateList = StateList.objects.all()
    try:
        additionalCharges = request.POST["additionalCharges"]
        retHashSeq = additionalCharges + '|' + salt + '|' + status + '|||||||||||' + email + '|' + firstname + '|' + productinfo + '|' + amount + '|' + txnid + '|' + key
    except Exception:
        retHashSeq = salt + '|' + status + '|||||||||||' + email + '|' + firstname + '|' + productinfo + '|' + amount + '|' + txnid + '|' + key
    hashh = hashlib.sha512(retHashSeq.encode(encoding='utf_8', errors='strict')).hexdigest().lower()
    if(hashh != posted_hash):
        print ("Invalid Transaction. Please try again")
    else:
        try:
            check_txnid = get_object_or_404(Order, user_id=request.session.get('site_userId'), txnid=txnid)
        except:
            check_txnid = None
        if check_txnid == None:    
            print("something went wrong!")
        print ("Thank You. Your order status is ", status)
        print ("Your Transaction ID for this transaction is ", txnid)
        print ("We have received a payment of Rs. ", amount , ". Your order will soon be shipped.")
    return render_to_response(request, "PayU/failure.html", c, locals())


def update_order_status(order_id):
    try:
        order = get_object_or_404(Order, id=order_id)
    except:
        order = None
    if order != None:
        order.status = 'P'
        order.save()
        
class SubCategory(TemplateView): 
    template_name = 'ecomsite/subcategory.html' 

    def post(self, request, *args, **kwargs):
        postdata = request.POST.copy()

        if request.POST.get('searchbtn') == 'Search':
            request.session['page'] = 'search'
            try:
                strValue = postdata.get('searchtxt')
            except:
                strValue = ''
            urlVar = '/search?stxt='+strValue
            
            if strValue == '':
                return HttpResponseRedirect(reverse('empty_search')) 
            else:
                return HttpResponseRedirect(urlVar) 
                        
        responseData = super(SearchView, self).get(request, *args, **kwargs)
        return responseData
     
    def get_context_data(self, **kwargs): 
        context = super(SubCategory, self).get_context_data(**kwargs) 
        pid = self.kwargs['cat_id'] 
        if self.request.session.get('site_userId') != '0': 
            context['cart_count'] = Cart.objects.filter(cart_id=user_cart._cart_id(self.request)).count() 
        else: 
            context['cart_count'] = Cart.objects.filter(user=self.request.session.get('site_userId')).count() 
             
        homeSettng = HomeSetting.objects.filter(user=getUserID()).first() 
        context['home_setting'] = homeSettng 
        context['home_seting_option'] = HomeSettingOptions.objects.filter(user=getUserID()).first() 
        context['isLogo'] = homeSettng.logo 
        context['isTagline'] = homeSettng.headline 
        context['isMenu'] = homeSettng.menu 
        context['isSearchBar'] = homeSettng.searchbar 
        context['isCart'] = homeSettng.cart_symbol 
        context['isFooter'] = homeSettng.footer  
        cat_list = Category.objects.filter(user=getUserID(), is_active=True) 
        context['cat_list'] = cat_list         
        context['pageTitle'] = "FAQs" 
        cat_list_p = Category.objects.filter(user=getUserID(), parent=None, is_active=1) 
        sub_cat_list = Category.objects.filter(user=getUserID(), parent=pid, is_active=1) 
        context['cat_list_p'] = cat_list_p 
        context['sub_cat_list'] = sub_cat_list 
        try: 
            sellerAddress = Address.objects.filter(user=getUserID()).first()  
        except: 
            sellerAddress = None 
     
        context['address'] = sellerAddress 
        user = userDetails.objects.filter(id=self.request.session.get('site_userId'))
        for res in user:
            context['user_name'] = res.username
        return context

# added by sushant razorpay 13/12/2018
def rezorPaySuccess(request):
    postdata = request.POST.copy()
    payment_id = request.POST["pay_name"]

    print("1111111111111111")
    print(payment_id)

    #lient = razorpay.Client(auth=(RAZORPAY_INFO["api_key"], RAZORPAY_INFO["secret_key"]))  #######31-07-19######
    client = razorpay.Client(auth=(RAZORPAY_INFO["test_api_key"], RAZORPAY_INFO["test_secret_key"]))

    payment_response = client.payment.fetch(payment_id)
    print(payment_response)
    print("YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY")
    
    if str(payment_response["status"]) == "authorized":
        cart_calculations = user_cart.cartCalculations(request)
        cart_amount = cart_calculations["cart_total"]
        cart_amount_in_paise = round(cart_amount * 100, 2)
        print("ZZZZZZZZZZZZZZZZZZZZZ")
        # delete cart details
        cartList = Cart.objects.filter(user=request.session.get('site_userId'))
        for cartData in cartList:
            cartData.delete() 
        import os,inspect
        path = os.path.dirname(os.path.abspath(inspect.getfile(inspect.currentframe()))) + "/error38.txt"
        file = open(path,"w+")  # to append line use a+ instead of w+              
        file.write(str('arehcdjp;lrfjsrthydfhf;l'))
        file.close()
        print("2222222222222222")
        print(payment_response["amount"])
        print(cart_amount_in_paise)
        print(cart_calculations)
        print(payment_response)

        if str(payment_response["amount"]) == str(cart_amount_in_paise):
            import os,inspect
            path = os.path.dirname(os.path.abspath(inspect.getfile(inspect.currentframe()))) + "/error28.txt"
            file = open(path,"w+")  # to append line use a+ instead of w+              
            file.write(str('arehcdjp;lrfjsrthydfhf;l'))
            file.close()
            print("3333333333333333333")
            capture_response = client.payment.capture(payment_id, cart_amount_in_paise)

            order_id = request.session.get('order_id')
            print(order_id)

            # order_info = Order.objects.latest('id')
            order_info = get_object_or_404(Order,id=order_id)
            orderitem = get_object_or_404(OrderItem,order_id=order_id)
            print("444444444444444444")
            print(payment_id)
            # ts = int(time.time())  
            # txnid = str(ts) + "XX" + str(order_id)
            txnid = payment_response["id"]
            print(txnid)
            order_info.txnid = txnid
            #order_info.depis_paid=1
            print(order_info.txnid)
            print(order_info.id)
            print("IDDDDDDDDDDDDDDDDD")
            print(order_info.user.username)
            print(order_info.user.email)
            print(order_info.user.mobile)
            print(orderitem.quantity)
            print(orderitem.product.sku)
            print(order_info.total)
            print(orderitem.booking_dt)
            date_email=orderitem.booking_dt
            print(date_email)
            print(type(date_email))
            print("&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&")
            # date_time_obj = datetime.date.strptime(vvv, '%d/%m/%Y')
            # print(date_time_obj)
            # print("PPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPppp")
            # date_depo = date_time_obj - timedelta(days=7)
            # print(date_depo.day)
            # print(date_depo.month)
            # print(date_depo.year)
            print("^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^")
            print(orderitem.delivery_dt)
            print(order_info.final_deposite)
            
            print(order_info.txnid)
            print(orderitem.booking_days)
            print(orderitem.product.name)

            order_info.save()
            import os,inspect
            path = os.path.dirname(os.path.abspath(inspect.getfile(inspect.currentframe()))) + "/error48.txt"
            file = open(path,"w+")  # to append line use a+ instead of w+              
            file.write(str('arehcdjp;lrfjsrthydfhf;l'))
            file.close()

            # print(myvars[0]['txnid'])
            #print(myvars)
            from django.core.mail import send_mail
            print("LLLLLLLLLLLLLLLLLLLLLLLl")
            subject, from_email, to = 'Thank you for your order!', 'Srishringarr <info@srishringarr.com>', 'info@srishringarr.com'
            html_content = render_to_string('ecomsite/email_send_admin.html', locals())
            text_content = strip_tags(html_content)
            html_content = '<p>This is an <strong>important</strong> message.</p>'
            msg = EmailMultiAlternatives(subject, text_content, from_email, [to])
            print("--------------------------------------------------------")
            msg.attach_alternative(html_content, "ecomsite/email_send_admin.html")
            print(msg)
            msg.send()

        payment_dict={'order_id': request.session.get('order_id')}
    return HttpResponseRedirect(reverse('thank_you', kwargs=payment_dict))

def placeOrder(request):
    print("IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII")
    order = Order()
    print(order)
    print("OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO")
    postdata=request.POST.copy()
    print(postdata)

    order.payment_mode = postdata.get('payment_mode')
    ba_pinzip = postdata.get('ba_pinzip')
    print(order.payment_mode)

    print(order.id)
    print(request.session.get('site_userId'))
    try:

        add = get_object_or_404(Address, user=request.session.get('site_userId'))
        print(request.session.get('site_userId'))
    except:
        add = None
    print(add)
    order.address = add
    cart_calculations = user_cart.cartCalculations(request)
    print(cart_calculations)
    print("this is cart calculation")
    if ba_pinzip != 0:
        try:
            cart_setting_o = CartSettingOptions.objects.filter(user=getUserID()).first()
        except:
            cart_setting_o = None
        # if  cart_setting_o is not None:   
            # dCharges = user_cart.calculateDeliveryCharge(ba_pinzip, cart_setting_o)
    print("this is cart calculationsssssssssss")
    order.total = cart_calculations['cart_total']
	#order.total = cart_calculations['cart_total'] + cart_calculations['total_shipping_charge']
    order.final_deposite = cart_calculations['deposite_total']
    # order.delivery_chgs = dCharges
    order.status = 'P'
    print("ssssssssssthis is cart calculationsssssssssss")
    # vikrant 130920
    order.bust_size=cart_calculations['bust_size']   
    order.waist_size=cart_calculations['waist_size']
    order.hips_size=cart_calculations['hips_size']
    print("ssssssssssthis is cart calculationsssssssssssxxxxxxxxx")
    # vikrant 130920
    order.tax = cart_setting_o.estimate_tax
    order.user = get_object_or_404(userDetails, id=request.session.get('site_userId'))
    order.seller = get_object_or_404(userDetails, id=getUserID())
    print("xxxxxxxxxxxssssssssssthis is cart calculationsssssssssssxxxxxxxxx")
    order.save()
    print("llllllllllllllllllllxxxxxxxxxxxssssssssssthis is cart calculationsssssssssssxxxxxxxxx")
    
    # user_details.email = user_email
    # print("emaillll2022222222222222222222222222222222222222")
    # print(user_email)
    print("<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>")
    print(order.bust_size)
    print(order.id)
    s = order.id
    p=order.txnid
    print(p)
    print("nnnnnnnnnnneewwwwwwwwwwwwwwwwwwwwwwwwww")
    cursor = connection.cursor()
    # print("SQLLLLLLLLLLLLLLLLLLLLLLLLLLL")
    cursor.execute(''' SELECT txnid , total FROM `orders` WHERE id = {0}'''.format(s)) 
    myvars = dictfetchall(cursor)
    #print(myvar[0]['txnid'])
    print(myvars)
    print("fdgscgcgchgcccsgcsgsggscg")
    # cursor1.execute(''' SELECT txnid FROM `orders` WHERE orders.id = {0}'''.format(s.id))
    
    print(s)
    print(order.created_at)
    # print(order.product.name)
    print(order.total)

    request.session['order_id'] = order.id
    
    cartList = Cart.objects.filter(user=request.session.get('site_userId'))
    for cartData in cartList: 
        orderitem = OrderItem()
        orderitem.order = order
        
        currentProduct = get_object_or_404(Products, id=cartData.product.id)
        if currentProduct.isProductInStock():

            print("AAYA??????????????????????")
            # daterev = cartData.form_date
            # print(daterev)
            # date_frm=datetime.strptime(daterev, '%d/%m/%y')
            # print(date_frm)
            print("AAYA??????????????????????")
            orderitem.product = currentProduct
            print(orderitem.product)
            orderitem.quantity = cartData.quantity
            orderitem.booking_dt = cartData.form_date


            print(orderitem.booking_dt)
            # orderitem.booking_dt1 = '2019-08-19'
            # gg=orderitem.booking_dt
            # print(gg)
            orderitem.delivery_dt = cartData.to_date
            print(orderitem.delivery_dt)
            print("hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh")
            #vikrant1/10/19
            image=orderitem.product.product_image
            print(image)

            #book_date=orderitem.booking_dt

            #date_time_obj = datetime.strptime(book_date, '%d/%m/%Y')

            #print("PPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPppp")
            #date_depo = date_time_obj - timedelta(days=7)

            print("(((((((((((((()))))))))))))))))))))))))))))))))")
            # // vikrant23-09-19
            
            orderitem.booking_days = cartData.days_index
            orderitem.deposite=cartData.deposite
            orderitem.subtotal = cartData.total_final_price + cart_calculations['default_shipping_charge'] 
            # orderitem.subtotal = cartData.quantity * cartData.total_final_price
            currentProduct.quantity = currentProduct.quantity - cartData.quantity
            orderitem.transactionid = order.txnid
            print(orderitem.transactionid)
            print("oooooooooooooooooooookkkkkkkkkkkkkkkkkkkkkkkkk")
            print(orderitem.order_id)

            currentProduct.save()
            orderitem.save()

            try:
                ################# RAHUL 05-08-19##############################################################
                user_details = get_object_or_404(userDetails, id=request.session.get('site_userId'))
                print("emaillllllllllllllllllllllllllllllllllllllll")
                print(user_details.email)
               
                from django.core.mail import EmailMultiAlternatives
                
                subject, from_email, to = 'Thank you for your order!', 'Srishringarr <info@srishringarr.com>', user_details.email
                text_content = 'This is an important message.'
                #html_content = get_template('ecomsite/email_send.html')
                html_content = render_to_string('ecomsite/email_send_user.html',locals())
                msg = EmailMultiAlternatives(subject, text_content, from_email, [to])
                msg.attach_alternative(html_content, "text/html")
                msg.send()
                ################## RAHUL 05-08-19##############################################################

                # user_details = get_object_or_404(userDetails, id=request.session.get('site_userId'))
                # print("emaillllllllllllllllllllllllllllllllllllllll")
                # print(user_details.email)
                # from django.core.mail import send_mail
                # subject, from_email, to = 'hello', 'sushant@nucleusads.com', user_details.email
                # html_content = render_to_string('ecomsite/payment_success_email.html', locals())
                # text_content = strip_tags(html_content)
                # html_content = '<p>This is an <strong>important</strong> message.</p>'
                # msg = EmailMultiAlternatives(subject, text_content, from_email, [to])
                # msg.attach_alternative(html_content, "ecomsite/payment_success_email.html")
                # msg.send()

            except:
                user_details = None
        # cartData.delete()



    # order_detail = Order.objects.filter(order_id=order.id)
    # context = super(placeOrder, self)
    # context['pageTitle'] = "place order"
    # self.request.session['order_id'] = ''
    # order_id = self.kwargs['order_id']
    # order = Order.objects.filter(id=order_id).first()
    # orderProduct = OrderItem.objects.filter(order=order_id)
    # context['orderItems'] = orderProduct
    # context['orderData'] = order
    ################## RAHUL 05-08-19##############################################################
    # from django.core.mail import send_mail
    # print("REACHED HEREEEEEEEEEEEEEEEE")
    # subject, from_email, to = 'Thank you for your order!', 'Srishringarr <info@srishringarr.com>', 'info@srishringarr.com'
    # html_content = render_to_string('ecomsite/email_send_admin.html', locals())
    # text_content = strip_tags(html_content)
    # html_content = '<p>This is an <strong>important</strong> message.</p>'
    # msg = EmailMultiAlternatives(subject, text_content, from_email, [to])
    # msg.attach_alternative(html_content, "ecomsite/email_send_admin.html")
    # print("AND HEREEEEEEEEEEEEEEEE")
    # msg.send()
    # print("HEREEEEEEEEEEEEEEEE TOOO")
###################### RAHUL 05-08-19##############################################################    




    # subject, from_email, to = 'hello', 'sushant@nucleusads.com', 'info@srishringarr.com'
    # html_content = render_to_string('ecomsite/payment_success_email.html', locals())
    # text_content = strip_tags(html_content)
    # html_content = '<p>This is an <strong>important</strong> message.</p>'
    # msg = EmailMultiAlternatives(subject, text_content, from_email, [to])
    # msg.attach_alternative(html_content, "ecomsite/payment_success_email.html")
    # msg.send()


    response = {'success':'true',
                'order_id':order.id ,             
                }
    return JsonResponse(response)   


def placeOrderdepo(request):

    order = Order()
    print(order)
    print("OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO")
        
    print(order.id)

    request.session['order_id'] = order.id
     
    response = {'success':'true',
                'order_id':order.id ,             
                }
    return JsonResponse(response)  

def razorpaypayment_successdepo(request):

    print("ccccccccccccccccccccccccccccccccccccccccccc")
    postdata = request.POST.copy()
    list_orderid=postdata.getlist('buttonid')
    # print(list_orderid)
    # print(type(list_orderid))
    # print(list_orderid[0])

    order_id=list_orderid[0]
    print("XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX")

    # order_DEPO = Order.objects.filter(user_id=request.session.get('site_userId'))

    # for cartData in order_DEPO:
    #     print(cartData)
    print("tttttttttttttttttttttttt")
    print(postdata)
    payment_id = request.POST["pay_name"]


    print(".......................................................")
    print(payment_id)

    client = razorpay.Client(auth=(RAZORPAY_INFO["test_api_key"], RAZORPAY_INFO["test_secret_key"]))  #######31-07-19######
    #client = razorpay.Client(auth=(RAZORPAY_INFO["test_api_key"], RAZORPAY_INFO["test_secret_key"]))

    payment_response = client.payment.fetch(payment_id)
    print(payment_response)
    
    if str(payment_response["status"]) == "authorized":
        print("ZZZZZZZZZZZZZZZZZZZZZ")
       
        order_depo_amt = Order.objects.filter(id=order_id)

        for i in order_depo_amt:
            print(i.final_deposite)

        dep_amt=int(i.final_deposite)

        deposit_amount_inpaise=round(dep_amt * 100, 2)
        print(type(deposit_amount_inpaise))
        print(deposit_amount_inpaise)
        print("2222222222222222")
        print(payment_response["amount"])
        

        if str(payment_response["amount"]) == str(deposit_amount_inpaise):
            print("3333333333333333333")
            capture_response = client.payment.capture(payment_id, deposit_amount_inpaise)

            user_id = request.session.get('site_userId')
            print(user_id)

            cursor = connection.cursor()
            # print("SQLLLLLLLLLLLLLLLLLLLLLLLLLLL")
            # cursor.execute(''' SELECT id FROM `orders` WHERE user_id = {0}'''.format(user_id)) 
            # myvars = dictfetchall(cursor)

            # print(myvars)
            # for usrid in myvars:
            #     print(usrid)

            # order_info = Order.objects.latest('id')
            order_info = get_object_or_404(Order,id=order_id)
            # orderitem = get_object_or_404(OrderItem,order_id=order_id)
            print("444444444444444444")
            print(payment_id)
            
            txnid = payment_response["id"]
            print(txnid)
            order_info.txnid_deposit_paid = txnid
            depo_date=date.today()
            print(depo_date)

            order_info.deposite_collect=depo_date

            order_info.depis_paid=1
            order_info.save()


            user_details = get_object_or_404(userDetails, id=request.session.get('site_userId'))
            print("emailaaaaaaa gayaaaaaa")
            print(user_details.email)

            
            print("TTTTTTTTTTTTTTTTTTTTTT")
            from django.core.mail import send_mail
            print("maiiiiiiiiiiiiiiiiiiillllllllllllllllllllllllllllll")
            subject, from_email, to = "We've received your deposit", 'Srishringarr <info@srishringarr.com>', user_details.email
            html_content = render_to_string('ecomsite/deposite_collect_email.html', locals())
            text_content = strip_tags(html_content)
            html_content = '<p>This is an <strong>important</strong> message.</p>'
            msg = EmailMultiAlternatives(subject, text_content, from_email, [to])
            msg.attach_alternative(html_content, "ecomsite/deposite_collect_email.html")
            msg.send()
           
            
            
    payment_dict={'order_id': request.session.get('order_id')}

    return HttpResponseRedirect(reverse('my_orders'))
